# 2 基于角动量准则的机械臂设计

github 图床 token： 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
2022-10-08: github 图床token：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
2020-10-25: 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
2022-12-07：github 图床 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

## 研究背景

## 研究思路

![研究思路](https://s2.loli.net/2022/05/31/TSvWFe35kop4HXn.png)

## 研究方法

### 角动量假设验证

#### 角动量假设与猜想

##### 假设

1. 手臂在人体运动时的摆动可以<font color='red'>抵消腿产生的角动量或者可延缓身体角动量的增加</font>，给予<font color='red'>更长的时间</font>帮助身体恢复平衡。

##### 角动量<font color='red'>期望与猜想</font>

1. 局部作用（比例关系）
   $$
   \frac{L_{arm}}{L_{leg}}=K、\frac{L_{arm}}{L_{trunk}}=K......
   $$

2. 全局作用
   $$
   L_{arm}+L_{leg}+L_{trunk}=N
   $$
   

#### 人体运动动力学

##### 二维平面内的人体运动动力学方程

<img src="https://s2.loli.net/2022/06/12/OjWBhnSI5k7uxwN.png" alt="human2D - 副本.drawio" style="zoom:67%;" />
$$
\begin{bmatrix} 
M_{11} &M_{12} &M_{13} &M_{14} &M_{15} &M_{16} &M_{17}\\
M_{21} &M_{22} &M_{23} &M_{24} &M_{25} &M_{26} &M_{27}\\
M_{31} &M_{32} &M_{33} &M_{34} &M_{35} &M_{36} &M_{37}\\
M_{41} &M_{42} &M_{43} &M_{44} &M_{45} &M_{46} &M_{47}\\
M_{51} &M_{52} &M_{53} &M_{54} &M_{55} &M_{56} &M_{57}\\
M_{61} &M_{62} &M_{63} &M_{64} &M_{65} &M_{66} &M_{67}\\
M_{71} &M_{72} &M_{73} &M_{74} &M_{75} &M_{76} &M_{77}\\
\end{bmatrix} 
\begin{bmatrix} 
\ddot{x}\\ 
\ddot{z}\\ 
\ddot{\theta}_1\\ 
\ddot{\theta}_2\\
\ddot{\theta}_3\\
\ddot{\theta}_4\\
\ddot{\theta}_5\\
\end{bmatrix} + 
\begin{bmatrix} 
C_1\\ 
C_2\\ 
C_3\\
C_4\\
C_5\\
C_6\\
C_7\\
\end{bmatrix} + 
\begin{bmatrix} 
G_1\\
G_2\\ 
G_3\\
G_4\\
G_5\\
G_6\\
G_7\\
\end{bmatrix} =
\begin{bmatrix} 
F_x\\
F_z\\ 
\tau_1\\
\tau_2\\
\tau_3\\
\tau_4\\
\tau_5\\
\end{bmatrix}
$$

$$
\left\{
\begin{aligned}
M_{11} &=
m_1+_2+m_3+m_4+m_5 \\
M_{12} &= 0\\
M_{13} &=
-m_2l_1C_1-l_1m_3C_1+l_1m_4C_1+l_1m_5C_1+l_2m_2C_{1,2}+l_3m_3C_{1,1}+l_4m_4C_{1,2}+l_5m_5C_{1,1}\\
M_{14} &=
l_2m_2C_{1,2}+l_3m_3C_{1,1}+l_4m_4C_{1,2}+l_5m_5C_{1,1}\\
M_{15} &=M_{13}=
-m_2l_1C_1-l_1m_3C_1+l_1m_4C_1+l_1m_5C_1+l_2m_2C_{1,2}+l_3m_3C_{1,1}+l_4m_4C_{1,2}+l_5m_5C_{1,1}\\
M_{16} &=M_{14}=
l_2m_2C_{1,2}+l_3m_3C_{1,1}+l_4m_4C_{1,2}+l_5m_5C_{1,1}\\
M_{17} &=M_{13}=
-m_2l_1C_1-l_1m_3C_1+l_1m_4C_1+l_1m_5C_1+l_2m_2C_{1,2}+l_3m_3C_{1,1}+l_4m_4C_{1,2}+l_5m_5C_{1,1}\\
\end{aligned}
\right.
$$

$$
\left\{
\begin{aligned}
M_{21} &= 0\\
M_{22} &=
m_1+m_2+m_3+m_4+m_5 \\
M_{23} &=
l_1m_2S_1+l_1m_3S_1-l_1m_4S_1-l_1m_5S_1-l_2m_2S_{1,2}-l_3m_3S_{1,1}-l_4m_4S_{1,2}-l_5m_5S_{1,1}\\
M_{24} &=
-l_2m_2S_{1,2}-l_3m_3S_{1,1}-l_4m_4S_{1,2}-l_5m_5C_{1,1}\\
M_{25} &=M_{23}=
l_1m_2S_1+l_1m_3S_1-l_1m_4S_1-l_1m_5S_1-l_2m_2S_{1,2}-l_3m_3S_{1,1}-l_4m_4S_{1,2}-l_5m_5S_{1,1}\\
M_{26} &=M_{24}=
-l_2m_2S_{1,2}-l_3m_3S_{1,1}-l_4m_4S_{1,2}-l_5m_5C_{1,1}\\
M_{27} &=M_{23}=
l_1m_2S_1+l_1m_3S_1-l_1m_4S_1-l_1m_5S_1-l_2m_2S_{1,2}-l_3m_3S_{1,1}-l_4m_4S_{1,2}-l_5m_5S_{1,1}\\
\end{aligned}
\right.
$$

$$
\left\{
\begin{aligned}
M_{31} &=
-l_1m_2C_1-l_1m_3C_1+l_1m_4C_1+l_1m_5C_1+l_2m_2C_{1,2}+l_3m_3C_{1,1}+l_4m_4C_{1,2}+l_5m_5C_{1,1}\\
M_{32} &=
l_1m_2S_1+l_1m_3S_1-l_1m_4S_1-l_1m_5S_1-l_2m_2S_{1,2}-l_3m_3S_{1,1}-l_4m_4S_{1,2}-l_5m_5S_{1,1}\\
M_{33} &= 
I_1+I_2+4I_3+I_4+4I_5+m_2l_1^2+m_3l_1^2+m_4l_1^2+m_5l_1^2+m_2l_2^2+m_3l_3^2+m_4l_4^2+m_5l_5^2-2l_1l_2m_2C_2-2l_1l_3m_3C_1+2l_1l_4m_4C_2+2l_1l_5m_5C_1\\
M_{34} &=
I_2+I_4+m_2l_2^2+m_3l_3^2+m_4l_4^2+m_5l_5^2-l_1l_2m_2C_2-l_1l_3m_3C_1+l_1l_4m_4C_2+l_1l_5m_5C_1\\
M_{35} &=
M_{33}\\
M_{36} &=
M_{34}\\
M_{37} &=
M_{33}\\
\end{aligned}
\right.
$$

$$
\left\{
\begin{aligned}
M_{41} &=
M_{14}\\
M_{42} &=
M_{24}\\
M_{43} &= 
M_{34}\\
M_{44} &=
I_2+I_4+m_2l_2^2+m_3l_3^2+m_4l_4^2+m_5l_5^2\\
M_{45} &=
I_2+I_4+m_2l_2^2+m_3l_3^2+m_4l_4^2+m_5l_5^2-l_1l_2m_2C_2-l_1l_3m_3C_1+l_1l_4m_4C_2+l_1l_5m_5C_1\\
M_{46} &=
I_2+I_4+m_2l_2^2+m_3l_3^2+m_4l_4^2+m_5l_5^2\\\\
M_{47} &=
I_2+I_4+m_2l_2^2+m_3l_3^2+m_4l_4^2+m_5l_5^2-l_1l_2m_2C_2-l_1l_3m_3C_1+l_1l_4m_4C_2+l_1l_5m_5C_1\\
\end{aligned}
\right.
$$

$$
\left\{
\begin{aligned}
M_{51} &=
M_{15}\\
M_{52} &=
M_{25}\\
M_{53} &= 
M_{35}\\
M_{54} &=
M_{45}\\
M_{55} &=
I_1+I_2+4I_3+I_4+4I_5+m_2l_1^2+m_3l_1^2+m_4l_1^2+m_5l_1^2+m_2l_2^2+m_3l_3^2+m_4l_4^2+m_5l_5^2-2l_1l_2m_2C_2-2l_1l_3m_3C_1+2l_1l_4m_4C_2+2l_1l_5m_5C_1\\
M_{56} &=
I_2+I_4+m_2l_2^2+m_3l_3^2+m_4l_4^2+m_5l_5^2-l_1l_2m_2C_2-l_1l_3m_3C_1+l_1l_4m_4C_2+l_1l_5m_5C_1\\
M_{57} &=
I_1+I_2+4I_3+I_4+4I_5+m_2l_1^2+m_3l_1^2+m_4l_1^2+m_5l_1^2+m_2l_2^2+m_3l_3^2+m_4l_4^2+m_5l_5^2-2l_1l_2m_2C_2-2l_1l_3m_3C_1+2l_1l_4m_4C_2+2l_1l_5m_5C_1\\
\end{aligned}
\right.
$$

$$
\left\{
\begin{aligned}
M_{61} &=
M_{16}\\
M_{62} &=
M_{26}\\
M_{63} &= 
M_{36}\\
M_{64} &=
M_{46}\\
M_{65} &=
M_{56}\\
M_{66} &=
I_2+I_4+m_2l_2^2+m_3l_3^2+m_4l_4^2+m_5l_5^2\\
M_{67} &=
I_2+I_4+m_2l_2^2+m_3l_3^2+m_4l_4^2+m_5l_5^2-l_1l_2m_2C_2-l_1l_3m_3C_1+l_1l_4m_4C_2+l_1l_5m_5C_1\\
\end{aligned}
\right.
$$

$$
\left\{
\begin{aligned}
M_{71} &=
M_{17}\\
M_{72} &=
M_{27}\\
M_{73} &= 
M_{37}\\
M_{74} &=
M_{47}\\
M_{75} &=
M_{57}\\
M_{76} &=
M_{67}\\
M_{77} &=
I_1+I_2+4I_3+I_4+4I_5+m_2l_1^2+m_3l_1^2+m_4l_1^2+m_5l_1^2+m_2l_2^2+m_3l_3^2+m_4l_4^2+m_5l_5^2-2l_1l_2m_2C_2-2l_1l_3m_3C_1+2l_1l_4m_4C_2+2l_1l_5m_5C_1\\
\end{aligned}
\right.
$$

$$
\left\{
\begin{aligned}
G_1 &=0\\
G_2 &=
m_1+m_2+m_3+m_4+m_5\\
G_3 &=
l_1m_2S_1+l_1m_3S_1-l_1m_4S_1-l_1m_5S_1-l_2m_2S_{1,2}-2l_3m_3S_{1,1}-l_4m_4S_{1,2}-2l_5m_5S_{1,1}\\
G_4 &=
-l_2m_2S_{1,2}-l_4m_4S_{1,2}\\
G_5 &=
l_1m_2S_1+l_1m_3S_1-l_1m_4S_1-l_1m_5S_1-l_2m_2S_{1,2}-2l_3m_3S_{1,1}-l_4m_4S_{1,2}-2l_5m_5S_{1,1}\\
G_6 &=
-l_2m_2S_{1,2}-l_4m_4S_{1,2}\\
G_7 &=
l_1m_2S_1+l_1m_3S_1-l_1m_4S_1-l_1m_5S_1-l_2m_2S_{1,2}-2l_3m_3S_{1,1}-l_4m_4S_{1,2}-2l_5m_5S_{1,1}\\
\end{aligned}
\right.
$$

##### 角动量计算方法

![antcal](https://s2.loli.net/2022/06/16/vEDaFkB2iTM6t5o.png)

<img src="https://s2.loli.net/2022/06/16/Lqc5WsfjkMUunpX.png" alt="antcal1" style="zoom: 67%;" />

<img src="https://s2.loli.net/2022/06/16/1tuCZpSUMNHyi89.png" alt="antcal2" style="zoom:67%;" />

<img src="https://s2.loli.net/2022/06/16/eKPbGTodmrA6a4c.png" alt="antcal3" style="zoom:67%;" />

##### 二连杆建模和计算

  <img src="https://s2.loli.net/2022/06/21/bDZYFnHgAt2BkWL.png" alt="而来杠杆" style="zoom:67%;" />  

  1. 二连杆运动学方程
     $$
     \left\{
     \begin{aligned}
     x_1 &= l_{c1}C_1 = \frac{1}{2}l_1C_1 \\
     y_1 &= l_{c1}S_1 = \frac{1}{2}l_1S_1\\
     x_2 &= l_1C_1+l_{c2}C_{1,2} = l_1C_1+\frac{1}{2}l_2C_{1,2} \\
     y_2 &= l_1S_1+l_{c2}S_{1,2} = l_1S_1+\frac{1}{2}l_2S_{1,2} \\
     \end{aligned}
     \right. \qquad \qquad \qquad
     \left\{
     \begin{aligned}
     \dot{x}_1 &= -l_{c1}S_1\dot{\theta}_1 = -\frac{1}{2}l_1S_1\dot{\theta}_1 \\
     \dot{y}_1 &= l_{c1}C_1\dot{\theta}_1 = \frac{1}{2}l_1C_1\dot{\theta}_1\\
     \dot{x}_2 &= -l_1S_1\dot{\theta}_1-l_{c2}S_{1,2}(\dot{\theta}_1+\dot{\theta}_2) = -l_1S_1\dot{\theta}_1-\frac{1}{2}l_2S_{1,2}(\dot{\theta}_1+\dot{\theta}_2)  \\
     \dot{y}_2 &= l_1C_1\dot{\theta}_1+l_{c2}C_{1,2}(\dot{\theta}_1+\dot{\theta}_2)  = l_1C_1\dot{\theta}_1+\frac{1}{2}l_2C_{1,2}(\dot{\theta}_1+\dot{\theta}_2)  \\
     \end{aligned}
     \right.
     $$

  2. 动力学方程
     $$
     \begin{bmatrix}
     M_{11} &M_{12}\\
     M_{21} &M_{22}\\
     \end{bmatrix} + 
     \begin{bmatrix}
     C_{1}\\
     C_{2}\\
     \end{bmatrix} + 
     \begin{bmatrix}
     G_{1}\\
     G_{2}\\
     \end{bmatrix} =
     \begin{bmatrix}
     \tau_{1}\\
     \tau_{2}\\
     \end{bmatrix}
     $$

     $$
     \left\{
     \begin{aligned}
     M_{11} &= m_2l_1^2+\frac{1}{3}m_1l_1^2+\frac{1}{3}m_2l_2^2+m_2l_1l_2C_2 \\
     &=m_1l_{c1}^2+m_2(l_1^2+l_{c2}^2+2l_1l_{c2}C_2)+I_1+I_2\\
     M_{12}&=\frac{1}{3}m_2l_2^2+\frac{1}{2}m_2l_1l_2C_2 \\
     &=m_2(l_{c2}^2+l_1l_{c2}C_2)+I_2\\
     &=M_{21}\\
     M_{22}&=\frac{1}{3}m_2l_2^2\\
     &=m_2l_{c2}^2+I_2\\
     \end{aligned}
     \right.
     $$

     $$
     \left\{
     \begin{aligned}
     C_{1} &= -m_2l_1l_2S_2\dot{\theta}_1\dot{\theta}_2- \frac{1}{2}m_2l_1l_2S_2\dot{\theta}_2^2\\
     &=-2m_2l_1l_{c2}S_2\dot{\theta}_1\dot{\theta}_2-m_2l_1l_{c2}S_2\dot{\theta}_2^2\\
     C_{2}&= \frac{1}{2}m_2l_1l_2S_2\dot{\theta}_1^2\\
     &=m_2l_1l_{c2}S_2\dot{\theta}_1^2\\
     \end{aligned}
     \right.
     $$

     $$
     \left\{
     \begin{aligned}
     G_{1} &= (\frac{1}{2}m_1+m_2)gl_1C_1+\frac{1}{2}m_2gl_2C_{1,2}\\
     &=(m_1l_{c1}+m_2l_1)gC_1+m_2gl_{c2}C_{1,2}\\
     G_{2}&= \frac{1}{2}m_2gl_2C_{1,2}\\
     &=m_2gl_{c2}C_{1,2}\\
     \end{aligned}
     \right.
     $$

  3. 通过求相对于原点的总角动量（即$L = L_1+L_2$)然后对L进行求导便可以得到相对于关节1的动力学方程，即上式的第一行。

#### 人体数据和数据采集设备

##### 人体质量数据

| 部分 | 重量占比 | 长度占比         | 重量（70kg） | 长度（1.75m） |
| ---- | -------- | ---------------- | ------------ | ------------- |
| 躯干 | 43.02%   | 30%              | 30.114       | 0.525         |
| 头劲 | 6.81%    | 10.75%           | 4.767        | 0.188         |
| 上臂 | 2.63%    | 17.25%           | 1.841        | 0.302         |
| 前臂 | 1.5%     | 15.85%+5.75%(手) | 1.05         | 0.277+0.1     |
| 双臂 | 9.43%    |                  | 6.601        |               |
| 大腿 | 14.47%   | 24.05%           | 10.129       | 0.42          |
| 小腿 | 4.57%    | 25.2%+4.25%(足)  | 3.199        | 0.441+0.074   |
| 双腿 | 40.74%   |                  | 28.518       |               |

##### 人体运动速度和步频

| 速度  | Ta (aerial) | Tc (contact) | Stance | T      |
| ----- | ----------- | ------------ | ------ | ------ |
| 3 m/s | 0.12 s      | 0.25 s       | 0.338  | 0.74 s |
| 4 m/s | 0.14 s      | 0.23 s       | 0.31   | 0.74 s |
| 5 m/s | 0.15 s      | 0.19 s       | 0.28   | 0.68 s |
| 6 m/s | 0.15 s      | 0.175 s      | 0.27   | 0.65 s |
| 7 m/s | 0.14 s      | 0.155 s      | 0.263  | 0.59 s |
| 8 m/s | 0.125 s     | 0.135 s      | 0.26   | 0.52 s |
| 9 m/s | 0.105 s     | 0.115 s      | 0.26   | 0.44 s |



- Nummela, Ari，Keränen, T., Mikkelsson, L. O., Factors related to top running speed and economy

  ![tstw1](https://s2.loli.net/2022/07/21/xylLj1UmJAeZ7KM.png)

- Faster top running speeds are achieved with greater ground forces not more rapid leg movements

  <img src="https://s2.loli.net/2022/07/21/KlxjybSzJcDnsiA.png" alt="tstw2"  />

- Ground contact time as an indicator of metabolic cost in elite distance runners

  ![tstw3](https://s2.loli.net/2022/07/21/AULMx4rgfa6DyJd.png)

- The biological limits to running speed are imposed from the ground up

  ![tstw4](https://s2.loli.net/2022/07/21/Dj76xTFkCLKJUcn.png)

- Differences in ground contact time explain the less efficient running economy in North African runners

  ![tstw5](https://s2.loli.net/2022/07/21/BUIb85n9LmVP4ud.png)



##### calc文件中序号和关节对应

| 关节            | 数据序号 |
| --------------- | -------- |
| hips            | 1        |
| right up leg    | 2        |
| right lower leg | 3        |
| right foot      | 4        |
| left up leg     | 5        |
| left lower leg  | 6        |
| left foot       | 7        |
| right shoulder  | 8        |
| right up arm    | 9        |
| right forearm   | 10       |
| right hand      | 11       |
| left shoulder   | 12       |
| left up arm     | 13       |
| left forearm    | 14       |
| left hand       | 15       |
| head            | 16       |
| neck            | 17       |

##### 坐标系定义
1. BVH-Global坐标准则下的世界坐标系及各关节坐标系（局部坐标系由于传感器穿戴会存在差异，并非始终为下图所示）

2. 世界坐标系（x 指向北方， y 指向东方， z 指向下方）

   <img src="https://s2.loli.net/2022/06/16/x8pfkV2D9FQlrg4.png" alt="bvh" style="zoom: 50%;" />

   <img src="https://s2.loli.net/2022/06/08/h5L34fyHFrmWoiS.png" alt="human3D_walk_axis.drawio" style="zoom: 50%;" />	

#### 正常步态下角动量数据化
##### walk步态下基于hip局部坐标的角动量测试

1. 数据结果

   <img src="https://s2.loli.net/2022/06/16/2yJWl7SrRCZduhM.png" alt="hip-ant" style="zoom: 67%;" />

   <img src="https://s2.loli.net/2022/06/16/KyZe3igb1DTzNsH.png" alt="hip-antsum" style="zoom:67%;" />
   
2. 数据结果分析

   问题：

   1. 给予hip局部坐标系的话是非惯性坐标系，当身体相对于惯性坐标系有速度和加速度时，由于矢量相加导致其他部分的速度并非简单的常数相加，涉及到矢量加乘，会导致结果产生差异，因此产生的结果不具有说服力。
   2. 周期内<font color='red'>角动量之和有什么意义</font>？<font color='DeepSkyBlue' size='6'>(>_<)有点自己的想法，OK？不要别人说什么你就做什么！！！</font>

##### walk步态下相对于支撑脚（惯性系下）坐标系的角动量测试

- 基于支撑脚局部坐标初步测试（相对于世界坐标系矢量加减），因此由于运动朝向和世界坐标系下的xy方向不同，因此该测试下只有绕z轴方向的角动量有参考意义，结果如下

  <img src="https://s2.loli.net/2022/06/16/hQodRXTs1kNqOvP.png" alt="ant" style="zoom:67%;" />

  <img src="https://s2.loli.net/2022/06/16/FkHKUawDSBhWRsv.png" alt="antsum" style="zoom: 50%;" />

  1. 结果数据分析



- walk步态下手臂摆动和束缚时的运动对比

  - **手臂摆动**：yuan-左脚为支撑点)

  ![antwalkarm2 - 副本](https://s2.loli.net/2022/06/17/PAWLu54wEzejM8a.png)

  - **手臂束缚**(yuan-左脚为支撑点)

    ![antwalknoarmL2-2](https://s2.loli.net/2022/06/20/mNoX8iFTK3pxhEk.png)
    

  

  - **手臂摆动/束缚对比**(liu-左脚为支撑点)

    <img src="https://s2.loli.net/2022/06/28/GFAOpK6sSVfY9qR.png" alt="walk-liu-ppt" style="zoom: 67%;" />

  1. 力/加速度对比

     **手臂摆动**：左脚为支撑点)

     <img src="https://s2.loli.net/2022/06/20/NuXYJiUH6Kxnsj4.png" alt="force-arm" style="zoom: 67%;" />

     **手臂束缚**：左脚为支撑点)

     <img src="https://s2.loli.net/2022/06/20/LNl2xYoq46keST7.png" alt="force-noarm" style="zoom:67%;" />

  - 结果分析
    1. 手臂摆动时，<font color='red'>手臂的角动量方向与身体的角动量方向相同，与腿的相反</font>，这就意味着，<font color='red'>身体和手臂的运动作用可以抵消腿部运动产生的角动量</font>，维持身体平衡。
    2. 测试刘哥和我，伟哥的运动时发现，<font color = 'red'>手臂的摆动角动量幅值基本维持在1左右，腿部角动量有较大的差距</font>。
    3. 好奇一点：<font color='DeepSkyBlue'>为什么右腿和左腿的角动量方向不同?</font>
    4. 手臂束缚时，<font color = 'red'>身体的角动量几乎为零，意味着手臂不摆动时，没有额外角动量可以抵消腿部产生的角动量</font>。但是身体的角动量变化幅值很小，直观理解，即使身体和手臂不懂，也能正常走，所以很可能在walk工况下手臂角动量的影响并不明显
    5. 另外一点：直觉不应该是束缚时躯干的角动量和腿的相反，臂不束缚更大？



#### 站立稳定恢复测试

##### **站立扰动后成功稳定恢复**

  1. 手臂摆动

  <img src="https://s2.loli.net/2022/06/24/uewjiM86V7J2QAC.png" alt="bal4" style="zoom: 80%;" />

  2. 手臂束缚

     <img src="https://s2.loli.net/2022/06/25/VomMD1FKyQGswcz.png" alt="noarm-bal" style="zoom:67%;" />
     
  3. 手臂束缚/摆动对比图

     <img src="https://s2.loli.net/2022/06/28/cs48YmvObf7n1oa.png" alt="balvs" style="zoom:67%;" />

  4. 结果分析：

     - 在扰动时，<font color = 'red'>手臂的角动量始终与躯干的角动量相反，幅值相当</font>，抵消由于初始扰动身体偏置导致产生的身体角动量。

     - 手臂摆动时，可以发现尽管存在着一定的相位差，但手臂的摆动角动量趋势是<font color = 'red'>尽可能完全抵消身体的角动量</font>，因此可以推测在稳定恢复时，<font color = 'red'>手臂的作用是使得身体的总的角动量为零</font>，这样可以降低关节和足底恢复身体需要的力，即满足：。
       $$
       L_{arm}+L_{leg}+L_{trunk}=0
       $$
       

##### **站立扰动稳定恢复失败**

  1. 手臂摆动
  
     ![failed_arm](https://s2.loli.net/2022/06/25/muTCUHDNk5F8s1y.png)
  
  2. 手臂束缚
     ![failed_no_arm](https://s2.loli.net/2022/06/25/16bDqlUVdyajINg.png)
     
  3. 手臂束缚/摆动对比图
  
     <img src="https://s2.loli.net/2022/06/28/oxsUIE8baX7frg9.png" alt="balfail" style="zoom:67%;" />

- 结果分析

  1. 站立稳定恢复时，<font color = 'red'>x，y方向手臂的角动量与身体相反，且手臂幅值与腿加躯干的相当</font>，因此由于初始扰动和重力作用产生的角动量可以通过手臂的挥动来抵消，这样可以减少腿部和腰部来帮助身体恢复平衡时需要的能量消耗。
  2. 对于成功稳定恢复工况，手臂摆动与束缚情况相比，<font color = 'red'>摆动时稳定恢复的时间更长，但是角动量幅值更小</font>，这样腰部和腿部控制身体平衡时需要消耗的能量和作用力就更小。
  3. 对于无法站立稳定恢复，需要迈出一步来平衡身体的工况下，<font color = 'red'>一方面手臂摆动可以增加恢复时间</font>，给于下肢和腰部更多的反应时间迈腿和作用，<font color = 'red'>同时摆臂是躯干的角动量幅值更小</font>。
  

#### 站立稳定恢复中的动能数据分析

- 手臂摆动![能量-arm](https://s2.loli.net/2022/06/28/MSIpHGkUln67JDe.png)：liu

  

- 手臂束缚：liu

  ![能量](https://s2.loli.net/2022/06/28/cUXm823WDGjoiRz.png)

- 结果分析

  1. 分析束缚和摆臂时的动能数据，除了束缚时身体的动能更大，手臂的动能更小，并未发现其他更显著的规律。

#### 角动量假设工作总结

##### **从角动量角度出发，分析身体受扰动后的手臂摆动的作用机理**

- <font color = 'red'>手臂的角动量与躯干相反，幅值接近</font>，抵消由于初始扰动导致产生的身体角动量。
- <font color = 'red'>手臂摆动和束缚相比，躯干的角动量幅值更小</font>
- 对于无法站立稳定恢复，<font color = 'red'>手臂摆动可以增加恢复时间，同时摆臂时躯干的角动量幅值更小</font>

##### 手臂摆动在身体受扰动稳定恢复过程的全局作用

$$
L_{arm}+L_{leg}+L_{trunk}=0
$$

- 通过该公式，在角动量最大和最小是带入轨迹人体运动数据结合机器人参数可以得到<font color = 'red'>手臂质量的初始优化范围</font>。

#### 基于人体数据采集角动量分析工作的问题

- 臂的摆动在不同实验对象不同工况下的存在差异，难以进行统一的解释。
- 采集到的数据缺少如足底力和力矩信息，难以进行完整的动力学分析。





### 机械臂参数优化的方法和计划

#### 方法

- 计算人体二维简化模型运动轨迹，基于完整数据进行人体运动的动力学分析。



#### 目标和预期结果

- 对扰动平衡恢复，臂摆动和束缚下身体关节力矩和足底力的影响（<font color = 'red'>手臂摆动可以降低关节力矩和足底力</font>）。

- 做出不同手臂<font color = 'red'>质量、惯量参数下关节力矩、足底力、功率等参数的分布图</font>（之后根据关节力矩等需求选择质量惯量参数）。

  

#### 人体九连杆简化模型

<img src="https://s2.loli.net/2022/07/01/xhMcLmfZzCr8lAw.png" alt="human2D.drawio" style="zoom:67%;" />

##### 运动学方程

$$
\left\{
\begin{aligned}
x_0 &= x_r+l_0S_0\\
z_0 &= z_r-l_0C_0\\
x_1 &= x_r+L_0S_0+l_1S_{0,1}\\
z_1 &= z_r-L_0C_0-l_1C_{0,1}\\
x_2 &= x_r+L_0S_0+L_1S_{0,1}+l_2S_{0,1,2}\\
z_2 &= z_r-L_0C_0-L_1C_{0,1}-l_2C_{0,1,2}\\
x_3 &= x_r+L_0S_0+l_1S_{0,3}\\
z_3 &= z_r-L_0C_0-l_1C_{0,3}\\
x_4 &= x_r+L_0S_0+L_1S_{0,3}+l_2S_{0,3,4}\\
z_4 &= z_r-L_0C_0-L_1C_{0,3}-l_2C_{0,3,4}\\
x_5 &= x_r+l_3S_{0,5}\\
z_5 &= z_r-l_3C_{0,5}\\
x_6 &= x_r+L_3S_{0,5}+l_4S_{0,5,6}\\
z_6 &= z_r-L_3C_{0,5}-l_4C_{0,5,6}\\
x_7 &= x_r+l_3S_{0,7}\\
z_7 &= z_r-l_3C_{0,7}\\
x_8 &= x_r+L_3S_{0,7}+l_4S_{0,7,8}\\
z_8 &= z_r-L_3C_{0,7}-l_4C_{0,7,8}\\
\end{aligned}
\right.
$$



##### 全神动力学方程

$$
\begin{bmatrix}
\mathrm{M}_{b,b} &\mathrm{M}_{b,lg} &\mathrm{M}_{b,rg} &\mathrm{M}_{b,la} &\mathrm{M}_{b,ra}\\
\mathrm{M}^T_{b,lg} &\mathrm{M}_{lg,lg} &\mathrm{0} &\mathrm{0} &\mathrm{0}\\
\mathrm{M}^T_{b,rg} &\mathrm{0} &\mathrm{M}_{rg,rg} &\mathrm{0} &\mathrm{0}\\
\mathrm{M}^T_{b,la} &\mathrm{0} &\mathrm{0} &\mathrm{M}_{la,la} &\mathrm{0}\\
\mathrm{M}^T_{b,ra} &\mathrm{0} &\mathrm{0} &\mathrm{0} &\mathrm{M}_{ra,ra}\\
\end{bmatrix}
\begin{bmatrix}
\ddot{x}\\
\ddot{y}\\
\ddot{\theta}_{lg1}\\
\ddot{\theta}_{lg2}\\
\ddot{\theta}_{rg1}\\
\ddot{\theta}_{rg2}\\
\ddot{\theta}_{la1}\\
\ddot{\theta}_{la2}\\
\ddot{\theta}_{ra1}\\
\ddot{\theta}_{ra2}\\
\end{bmatrix}
+
\begin{bmatrix}
\mathrm{G}_{b}\\
\mathrm{G}_{lg}\\
\mathrm{G}_{rg}\\
\mathrm{G}_{la}\\
\mathrm{G}_{ra}\\
\end{bmatrix}g
+
\begin{bmatrix}
\mathrm{C}_b\\
\mathrm{C}_{lg}\\
\mathrm{C}_{rg}\\
\mathrm{C}_{la}\\
\mathrm{C}_{ra}\\
\end{bmatrix}
=
\begin{bmatrix}
0 \\ 0 \\ \tau_{b} \\ \tau_{lg1} \\ \tau_{lg2} \\ \tau_{rg1} \\ \tau_{rg2} \\ 
\tau_{la1} \\ \tau_{la2}\\ \tau_{ra1} \\ \tau_{ra2}
\end{bmatrix}
+
\begin{bmatrix}
\mathrm{J}_l &\mathrm{J}_r
\end{bmatrix}
\begin{bmatrix}
F_{lx} \\ F_{ly} \\ F_{rx} \\ F_{ry}
\end{bmatrix}
$$

- 惯量项

$$
\begin{aligned}
&m_{xs\theta}=2L_0C_0(m_1+m_2)+m_0l_0C_0+\displaystyle\sum_{k=lg,rg,la,ra}
(m_{k2}L_{k1}C_{0,k1}+m_{k1}l_{k1}C_{0,k1}+m_{k2}L_{k2}C_{0,k1,k2})\\
&m_{x\theta\theta}=\hat{I}_{0,1,2,1,2,3,4,3,4}+2L_0^2(m_1+m_2)+2L_1^2m_2+2L_3^2m_4+\\
&2L_0L_1m_2(C_1+C_3)+2L_0l_1m_1(C_1+C_3)+2L_0l_2m_2(C_{1,2}+C_{3,4})+2L_1l_2m_2(C_2+C_4)+2L_3l_4m_4(C_6+C_8)\\
\\
&\mathrm{M}_{b,b} =
\begin{bmatrix}
m_{0,1,2,1,2,3,4,3,4} &0 &m_{xc\theta}\\
0 &m_{0,1,2,1,2,3,4,3,4} &m_{xs\theta}\\
m_{xc\theta} &m_{xs\theta} &m_{x\theta\theta}\\
\end{bmatrix}\\
\\
&\mathrm{M}_{b,lg} =
\begin{bmatrix}
m_2L_1C_{0,lg1}+m_1l_1C_{0,lg1}+m_2l_2C_{0,lg1,lg2} &m_2l_2C_{0,lg1,lg2}\\
m_2L_1S_{0,lg1}+m_1l_1S_{0,lg1}+m_2l_2S_{0,lg1,lg2} &m_2l_2S_{0,lg1,lg2}\\
\hat{I}_1+\hat{I}_2+L_1^2m_2+L_0L_1m_2C_{lg1}+L_0l_1m_1C_{lg1}+L_0l_2m_2C_{lg1,lg2}+2L_1l_2m_2C_{lg2}
&\quad\hat{I}_2+L_0l_2m_2C_{lg1,lg2}+L_1l_2m_2C_{lg2}
\end{bmatrix} \\
\\
&\mathrm{M}_{b,rg} =
\begin{bmatrix}
m_2L_1C_{0,rg1}+m_1l_1C_{0,rg1}+m_2l_2C_{0,rg1,rg2} &m_2l_2C_{0,rg1,rg2}\\
m_2L_1S_{0,rg1}+m_1l_1S_{0,rg1}+m_2l_2S_{0,rg1,rg2} &m_2l_2S_{0,rg1,rg2}\\
\hat{I}_1+\hat{I}_2+L_1^2m_2+L_0L_1m_2C_{rg1}+L_0l_1m_1C_{rg1}+L_0l_2m_2C_{rg1,rg2}+2L_1l_2m_2C_{rg2}
&\hat{I}_2+L_0l_2m_2C_{rg1,rg2}+L_1l_2m_2C_{rg2}
\end{bmatrix}\\
\\
&\mathrm{M}_{b,la} =
\begin{bmatrix}
m_4L_3C_{0,la1}+m_3l_3C_{0,la1}+m_4l_4C_{0,la1,la2} &m_4l_4C_{0,la1,la2}\\
m_4L_3S_{0,la1}+m_3l_3S_{0,la1}+m_4l_4S_{0,la1,la2} &m_4l_4S_{0,la1,la2}\\
\hat{I}_3+\hat{I}_4+L_3^2m_4+2L_3l_4m_4C_{la2}
&\hat{I}_4+L_3l_4m_4C_{la2}
\end{bmatrix} \\
\\
&\mathrm{M}_{b,ra} =
\begin{bmatrix}
m_4L_3C_{0,ra1}+m_3l_3C_{0,ra1}+m_4l_4C_{0,ra1,ra2} &m_4l_4C_{0,ra1,ra2}\\
m_4L_3S_{0,ra1}+m_3l_3S_{0,ra1}+m_4l_4S_{0,ra1,ra2} &m_4l_4S_{0,ra1,ra2}\\
\hat{I}_3+\hat{I}_4+L_3^2m_4+2L_3l_4m_4C_{ra2}
&\hat{I}_4+L_3l_4m_4C_{ra2}
\end{bmatrix}\\
\\
&\mathrm{M}_{lg,lg}=
\begin{bmatrix}
\hat{I}_1+\hat{I}_2+m_2L^2_1+2m_2l_{2}L_1C_{lg2} &\hat{I}_2+m_2l_{2}L_1C_{lg2}\\
\hat{I}_2+m_2l_{2}L_1C_{lg2} &\hat{I}_2
\end{bmatrix}\\
\\
&\mathrm{M}_{rg,rg}=
\begin{bmatrix}
\hat{I}_1+\hat{I}_2+m_2L^2_1+2m_2l_{2}L_1C_{rg2} &\hat{I}_2+m_2l_{2}L_1C_{rg2}\\
\hat{I}_2+m_2l_{2}L_1C_{rg2} &\hat{I}_2
\end{bmatrix}\\
\\
&\mathrm{M}_{la,la}=
\begin{bmatrix}
\hat{I}_3+\hat{I}_4+m_4L^2_3+2m_4L_3l_4C_{la2} &\hat{I}_4+m_4L_3l_4C_{la2}\\
\hat{I}_4+m_4L_3l_4C_{la2} &\hat{I}_4
\end{bmatrix}\\
\\
&\mathrm{M}_{ra,ra}=
\begin{bmatrix}
\hat{I}_3+\hat{I}_4+m_4L^2_3+2m_4L_3l_4C_{ra2} &\hat{I}_4+m_4L_3l_4C_{ra2}\\
\hat{I}_4+m_4L_3l_4C_{ra2} &\hat{I}_4
\end{bmatrix}

\end{aligned}
$$

- 重力项

$$
\begin{aligned}
&\mathrm{G}_b =
\begin{bmatrix}
0 \\ m_{0,1,2,1,2,3,4,3,4}\\
2L_0S_0(m_1m_2)+m_0l_0S_0+\displaystyle\sum_{k=lg,rg,la,ra}(L_{k1}m_{k2}C_{0,k1}+l_{k1}m_{k1}S_{0,k1}+l_{k2}m_{k2}S_{0,k1,k2})
\end{bmatrix}\\
\\
&\mathrm{G}_{lg} =
\begin{bmatrix}
(m_2L_1+m_1l_1)S_{0,lg1}+m_2l_2S_{0,lg1,lg2} \\
m_2l_2S_{0,lg1,lg2}
\end{bmatrix}\\
\\
&\mathrm{G}_{rg} =
\begin{bmatrix}
(m_2L_1+m_1l_1)S_{0,rg1}+m_2l_2S_{0,rg1,rg2} \\
m_2l_2S_{0,rg1,rg2}
\end{bmatrix}\\
\\
&\mathrm{G}_{la} =
\begin{bmatrix}
(m_4L_3+m_3l_3)S_{0,la1}+m_4l_4S_{0,la1,la2} \\
m_4l_4S_{0,la1,la2}
\end{bmatrix}\\
\\
&\mathrm{G}_{ra} =
\begin{bmatrix}
(m_4L_3+m_3l_3)S_{0,ra1}+m_4l_4S_{0,ra1,ra2} \\
m_4l_4S_{0,ra1,ra2}
\end{bmatrix}
\end{aligned}
$$

- 离心力项

$$
\begin{aligned}
&m_{bs\theta} = 2L_0S_0(m_1+m_2)+m_0l_0S_0+\displaystyle\sum_{k=lg,rg,la,ra}(L_{k1}m_{k2}S_{0,k1}+l_{k1}m_{k1}S_{0,k1}+l_{k2}m_{k2}S_{0,k1,k2})\\
\\
&m_{odd,s\theta}=L_{k1}m_{k2}S_{0,k1}+l_{k1}m_{k1}S_{0,k1}+l_{k2}m_{k2}S_{0,k1,k2}\\
\\
&m_{eve,s\theta}=l_{k2}m_{k2}S_{0,k1,k2}\\
\\
&m_{s\theta\theta1}=L_0(L_{k1}m_{k2}S_{k1}+l_{k1}m_{k1}S_{k1}+l_{k2}m_{k2}S_{k1,k2})\\
\\
&m_{s\theta\theta2}=m_{k2}l_{k2}(L_0S_{k1,k2}+L_{k1}S_{k2})\\
\\
&m_{s\theta\theta3}=m_{k2}l_{k2}L_{k1}S_{k2}\\
\\
&\mathrm{C}_b=
\begin{bmatrix}
-(m_{bs\theta})\dot{\theta}_0^2-
\displaystyle\sum_{k=...}(2m_{odd,s\theta}\dot{\theta}_0\dot{\theta}_{k1}+2m_{eve,s\theta}\dot{\theta}_0\dot{\theta}_{k2}+
m_{odd,s\theta}\dot{\theta}_{k1}^2+m_{eve,s\theta}\dot{\theta}_{k2}^2+2m_{odd,s\theta}\dot{\theta}_{k1}\dot{\theta}_{k2})\\
(m_{bc\theta})\dot{\theta}_0^2+
\displaystyle\sum_{k=...}(2m_{odd,c\theta}\dot{\theta}_0\dot{\theta}_{k1}+2m_{eve,c\theta}\dot{\theta}_0\dot{\theta}_{k2}+
m_{odd,c\theta}\dot{\theta}_{k1}^2+m_{eve,c\theta}\dot{\theta}_{k2}^2+2m_{odd,c\theta}\dot{\theta}_{k1}\dot{\theta}_{k2})\\
-\displaystyle\sum_{k=lg,rg}(2m_{s\theta\theta1}\dot{\theta}_0\dot{\theta}_{k1}+2m_{s\theta\theta2}\dot{\theta}_0\dot{\theta}_{k2}+m_{s\theta\theta1}\dot{\theta}_{k1}^2+m_{s\theta\theta2}\dot{\theta}_{k2}^2+2m_{s\theta\theta2}\dot{\theta}_{k1}\dot{\theta}_{k2})-\displaystyle\sum_{k=la,ra}(2m_{s\theta\theta3}\dot{\theta}_0\dot{\theta}_{k2}+2m_{s\theta\theta3}\dot{\theta}_{k1}\dot{\theta}_{k2}+m_{s\theta\theta3}\dot{\theta}_{k2}^2)
\end{bmatrix}\\
\\
&\mathrm{C}_{lg}=
\begin{bmatrix}
m_{s\theta\theta1,lg}\dot{\theta}_0^2-2m_{s\theta\theta3,lg}\dot{\theta}_0\dot{\theta}_{k2,lg}-2m_{s\theta\theta3,lg}\dot{\theta}_{k1,lg}\dot{\theta}_{k2,lg}-m_{s\theta\theta3,lg}\dot{\theta}_{k2,lg}^2\\
m_{s\theta\theta2,lg}\dot{\theta}_0^2+2m_{s\theta\theta3,lg}\dot{\theta}_0\dot{\theta}_{k1,lg}+m_{s\theta\theta3,lg}\dot{\theta}_{k1,lg}^2
\end{bmatrix}\\
\\
&\mathrm{C}_{rg}=
\begin{bmatrix}
m_{s\theta\theta1,rg}\dot{\theta}_0^2-2m_{s\theta\theta3,rg}\dot{\theta}_0\dot{\theta}_{k2,rg}-2m_{s\theta\theta3,rg}\dot{\theta}_{k1,rg}\dot{\theta}_{k2,rg}-m_{s\theta\theta3,rg}\dot{\theta}_{k2,rg}^2\\
m_{s\theta\theta2,rg}\dot{\theta}_0^2+2m_{s\theta\theta3,rg}\dot{\theta}_0\dot{\theta}_{k1,rg}+m_{s\theta\theta3,rg}\dot{\theta}_{k1,rg}^2
\end{bmatrix}\\
\\
&\mathrm{C}_{la}=
\begin{bmatrix}
-2m_{s\theta\theta3,la}\dot{\theta}_0\dot{\theta}_{k2,la}-2m_{s\theta\theta3,la}\dot{\theta}_{k1,la}\dot{\theta}_{k2,la}-m_{s\theta\theta3,la}\dot{\theta}_{k2,la}^2\\
m_{s\theta\theta2,la}\dot{\theta}_0^2+2m_{s\theta\theta3,la}\dot{\theta}_0\dot{\theta}_{k1,la}+m_{s\theta\theta3,la}\dot{\theta}_{k1,la}^2
\end{bmatrix}\\
\\
&\mathrm{C}_{ra}=
\begin{bmatrix}
-2m_{s\theta\theta3,ra}\dot{\theta}_0\dot{\theta}_{k2,ra}-2m_{s\theta\theta3,rg}\dot{\theta}_{k1,ra}\dot{\theta}_{k2,ra}-m_{s\theta\theta3,ra}\dot{\theta}_{k2,ra}^2\\
m_{s\theta\theta2,la}\dot{\theta}_0^2+2m_{s\theta\theta3,la}\dot{\theta}_0\dot{\theta}_{k1,la}+m_{s\theta\theta3,la}\dot{\theta}_{k1,la}^2
\end{bmatrix}\\
\end{aligned}
$$

- 接触矩阵
  $$
  \begin{aligned}
  &\mathrm{J}_l=\begin{bmatrix}
  1 &0\\
  0 &1\\
  L_1C_{l1}+L_2C_{l1,l2} &L_1S_{l1}+L_2S_{l1,l2}\\
  L_2C_{l1,l2} &L_2S_{l1,l2}\\
  0 &0\\ 0 &0
  \end{bmatrix}\\
  &\mathrm{J}_r=\begin{bmatrix}
  1 &0\\
  0 &1\\
  0 &0\\
  0 &0\\
  L_1C_{r1}+L_2C_{r1,r2} &L_1S_{r1}+L_2S_{r1,r2}\\
  L_2C_{r1,r2} &L_2S_{r1,r2}\\
  \end{bmatrix}\\
  \end{aligned}
  $$
  

##### 半神动力学方程1

- **x0,z0 in hip and $$\theta_{hhip} = \theta_{hip}$$**

$$
\begin{bmatrix}
\mathrm{M}_{b,b} &\mathrm{M}_{b,lg} &\mathrm{M}_{b,la}\\
\mathrm{M}^T_{b,lg} &\mathrm{M}_{lg,lg} &\mathrm{0}\\
\mathrm{M}^T_{b,la} &\mathrm{0} &\mathrm{M}_{la,la}\\
\end{bmatrix}
\begin{bmatrix}
\ddot{x}\\
\ddot{y}\\
\ddot{\theta}_{lg1}\\
\ddot{\theta}_{lg2}\\
\ddot{\theta}_{la1}\\
\ddot{\theta}_{la2}\\
\end{bmatrix}
+
\begin{bmatrix}
\mathrm{G}_{b}\\
\mathrm{G}_{lg}\\
\mathrm{G}_{la}\\
\end{bmatrix}g
+
\begin{bmatrix}
\mathrm{C}_b\\
\mathrm{C}_{lg}\\
\mathrm{C}_{la}\\
\end{bmatrix}
=
\begin{bmatrix}
0 \\ 0 \\ \tau_{b} \\ \tau_{lg1} \\ \tau_{lg2} \\ 
\tau_{la1} \\ \tau_{la2}\\
\end{bmatrix}
+
\begin{bmatrix}
\mathrm{J}_l &\mathrm{J}_r
\end{bmatrix}
\begin{bmatrix}
F_{lx} \\ F_{ly}
\end{bmatrix}
$$

- 惯量项

$$
\begin{aligned}
&m_{xc\theta}=-L_0C_0(m_3+m_4)-m_0l_0C_0+\displaystyle\sum_{k=la}
(m_{k2}L_{k1}C_{0,k1}+m_{k1}l_{k1}C_{0,k1}+m_{k2}l_{k2}C_{0,k1,k2})\\
&m_{xs\theta}=-L_0S_0(m_1+m_2)-m_0l_0S_0+\displaystyle\sum_{k=la}
(m_{k2}L_{k1}S_{0,k1}+m_{k1}l_{k1}S_{0,k1}+m_{k2}l_{k2}S_{0,k1,k2})\\
&m_{x\theta\theta}=\hat{I}_{0,3,4}+L_0^2(m_3+m_4)+L_3^2m_4-\\
&2L_0L_3m_4C_3-2L_0l_3m_3C_3+2L_0l_4m_4C_{3,4}+2L_3l_4m_4C_4\\
\\
&\mathrm{M}_{b,b} =
\begin{bmatrix}
m_{0,1,2,3,4} &0 &m_{xc\theta}\\
0 &m_{0,1,2,3,4} &m_{xs\theta}\\
m_{xc\theta} &m_{xs\theta} &m_{x\theta\theta}\\
\end{bmatrix}\\
\\
&\mathrm{M}_{b,lg} =
\begin{bmatrix}
m_2L_1C_{lg1}+m_1l_1C_{lg1}+m_2l_2C_{lg1,lg2} &m_2l_2C_{lg1,lg2}\\
m_2L_1S_{lg1}+m_1l_1S_{lg1}+m_2l_2S_{lg1,lg2} &m_2l_2S_{lg1,lg2}\\
0 &0
\end{bmatrix} \\
\\

&\mathrm{M}_{b,la} =
\begin{bmatrix}
m_4L_3C_{0,la1}+m_3l_3C_{0,la1}+m_4l_4C_{0,la1,la2} &m_4l_4C_{0,la1,la2}\\
m_4L_3S_{0,la1}+m_3l_3S_{0,la1}+m_4l_4S_{0,la1,la2} &m_4l_4S_{0,la1,la2}\\
\hat{I}_3+\hat{I}_4+L_3^2m_4+2L_3l_4m_4C_{la2}-L_0L_3m_4C_{la1}-L_0l_3m_3C_{la1}-L_0l_4m_4C_{la1,la2}
&\hat{I}_4+L_3l_4m_4C_{la2}-L_0l_4m_4C_{la1,la2}
\end{bmatrix} \\
\\

&\mathrm{M}_{lg,lg}=
\begin{bmatrix}
\hat{I}_1+\hat{I}_2+m_2L^2_1+2m_2l_{2}L_1C_{lg2} &\hat{I}_2+m_2l_{2}L_1C_{lg2}\\
\hat{I}_2+m_2l_{2}L_1C_{lg2} &\hat{I}_2
\end{bmatrix}\\
\\

&\mathrm{M}_{la,la}=
\begin{bmatrix}
\hat{I}_3+\hat{I}_4+m_4L^2_3+2m_4L_3l_4C_{la2} &\hat{I}_4+m_4L_3l_4C_{la2}\\
\hat{I}_4+m_4L_3l_4C_{la2} &\hat{I}_4
\end{bmatrix}\\
\\

\end{aligned}
$$

- 重力项

$$
\begin{aligned}
&\mathrm{G}_b =
\begin{bmatrix}
0 \\ m_{0,1,2,3,4}\\
m_{xs\theta}
\end{bmatrix}\\
\\
&\mathrm{G}_{lg} =
\begin{bmatrix}
(m_2L_1+m_1l_1)S_{lg1}+m_2l_2S_{lg1,lg2} \\
m_2l_2S_{lg1,lg2}
\end{bmatrix}\\
\\
&\mathrm{G}_{la} =
\begin{bmatrix}
(m_4L_3+m_3l_3)S_{0,la1}+m_4l_4S_{0,la1,la2} \\
m_4l_4S_{0,la1,la2}
\end{bmatrix}\\

\end{aligned}
$$

- 离心力项

$$
\begin{aligned}
&m_{bs\theta} = L_0S_0(m_3+m_4)+m_0l_0S_0-\displaystyle\sum_{k=la}(L_{k1}m_{k2}S_{0,k1}+l_{k1}m_{k1}S_{0,k1}+l_{k2}m_{k2}S_{0,k1,k2})\\
\\
&m_{odd,s\theta}=L_{k1}m_{k2}S_{0,k1}+l_{k1}m_{k1}S_{0,k1}+l_{k2}m_{k2}S_{0,k1,k2}\\
\\
&m_{odd,sg\theta}=L_{k1}m_{k2}S_{k1}+l_{k1}m_{k1}S_{k1}+l_{k2}m_{k2}S_{k1,k2}\\
\\
&m_{eve,s\theta}=l_{k2}m_{k2}S_{0,k1,k2}\\
\\
&m_{eve,sg\theta}=l_{k2}m_{k2}S_{k1,k2}\\
\\
&m_{s\theta\theta1}=L_0(L_{k1}m_{k2}S_{k1}+l_{k1}m_{k1}S_{k1}+l_{k2}m_{k2}S_{k1,k2})\\
\\
&m_{s\theta\theta2}=m_{k2}l_{k2}(L_0S_{k1,k2}-L_{k1}S_{k2})\\
\\
&m_{s\theta\theta3}=m_{k2}l_{k2}L_{k1}S_{k2}\\
\\
&\mathrm{C}_b=
\begin{bmatrix}
(m_{bs\theta})\dot{\theta}_0^2-
\displaystyle\sum_{k=la}(2m_{odd,s\theta}\dot{\theta}_0\dot{\theta}_{k1}+2m_{eve,s\theta}\dot{\theta}_0\dot{\theta}_{k2}+
m_{odd,s\theta}\dot{\theta}_{k1}^2+m_{eve,s\theta}\dot{\theta}_{k2}^2+2m_{odd,s\theta}\dot{\theta}_{k1}\dot{\theta}_{k2})-\displaystyle\sum_{k=lg}(m_{odd,sg\theta}\dot{\theta}_{k1}^2+2m_{eve,sg\theta}\dot{\theta}_{k1}\dot{\theta}_{k2}+m_{eve,sg\theta}\dot{\theta}_{k2}^2)\\
-(m_{bc\theta})\dot{\theta}_0^2+
\displaystyle\sum_{k=la}(2m_{odd,c\theta}\dot{\theta}_0\dot{\theta}_{k1}+2m_{eve,c\theta}\dot{\theta}_0\dot{\theta}_{k2}+
m_{odd,c\theta}\dot{\theta}_{k1}^2+m_{eve,c\theta}\dot{\theta}_{k2}^2+2m_{odd,c\theta}\dot{\theta}_{k1}\dot{\theta}_{k2})+\displaystyle\sum_{k=lg}(m_{odd,cg\theta}\dot{\theta}_{k1}^2+2m_{eve,cg\theta}\dot{\theta}_{k1}\dot{\theta}_{k2}+m_{eve,cg\theta}\dot{\theta}_{k2}^2)\\
\displaystyle\sum_{k=la}(2m_{s\theta\theta1}\dot{\theta}_0\dot{\theta}_{k1}+2m_{s\theta\theta2}\dot{\theta}_0\dot{\theta}_{k2}+m_{s\theta\theta1}\dot{\theta}_{k1}^2+m_{s\theta\theta2}\dot{\theta}_{k2}^2+2m_{s\theta\theta2}\dot{\theta}_{k1}\dot{\theta}_{k2})
\end{bmatrix}\\
\\
&\mathrm{C}_{lg}=
\begin{bmatrix}
-2m_{s\theta\theta3,lg}\dot{\theta}_{k1,lg}\dot{\theta}_{k2,la}-m_{s\theta\theta3,lg}\dot{\theta}_{k2,lg}^2\\
m_{s\theta\theta3,lg}\dot{\theta}_{k1,lg}^2
\end{bmatrix}\\
\\
&\mathrm{C}_{la}=
\begin{bmatrix}
-m_{s\theta\theta1,la}\dot{\theta}_0^2-2m_{s\theta\theta3,la}\dot{\theta}_0\dot{\theta}_{k2,la}-2m_{s\theta\theta3,la}\dot{\theta}_{k1,la}\dot{\theta}_{k2,la}-m_{s\theta\theta3,la}\dot{\theta}_{k2,la}^2\\
-m_{s\theta\theta2,la}\dot{\theta}_0^2+2m_{s\theta\theta3,la}\dot{\theta}_0\dot{\theta}_{k1,la}+m_{s\theta\theta3,la}\dot{\theta}_{k1,la}^2
\end{bmatrix}\\
\\
\end{aligned}
$$



##### 半神动力学方程2

<img src="https://s2.loli.net/2022/07/12/CtpIMsPK1U7cqiX.png" alt="human2D_walk_bal.drawio" style="zoom:67%;" />

- 运动学
  $$
  \left\{
  \begin{aligned}
  x_0 &= x_r-l_0S_0\\
  z_0 &= z_r+l_0C_0\\
  x_1 &= x_r+l_1S_{0,1}\\
  z_1 &= z_r-l_1C_{0,1}\\
  x_2 &= x_r+L_1S_{0,1}+l_2S_{0,1,2}\\
  z_2 &= z_r-L_1C_{0,1}-l_2C_{0,1,2}\\
  x_3 &= x_r-L_0S_0+l_3S_{0,3}\\
  z_3 &= z_r+L_0C_0-l_3C_{0,3}\\
  x_4 &= x_r-L_0S_0+L_3S_{0,3}+l_4S_{0,3,4}\\
  z_4 &= z_r+L_0C_0-L_3C_{0,3}-l_4C_{0,3,4}\\
  \end{aligned}
  \right.
  
  ​\Rightarrow​
  \left\{\begin{aligned}
  &\dot{x}_{0}= \dot{x}_{r}-l_0C_0\dot{\theta_0}\\
  &\dot{y}_{0}= \dot{y}_{r}-l_0S_0\dot{\theta_0}\\
  &\dot{x}_{1}= \dot{x}_{r}+l_1C_{0,1}\dot{\theta}_{0,1}\\
  &\dot{y}_{1}= \dot{y}_{r}+l_1S_{0,1}\dot{\theta}_{0,1}\\
  &\dot{x}_{2}= \dot{x}_{r}+L_1C_{0,1}\dot{\theta}_{0,1}+l_2C_{0,1,2}\dot{\theta}_{0,1,2}\\
  &\dot{y}_{2}= \dot{y}_{r}+L_1S_{0,1}\dot{\theta}_{0,1}+l_2S_{0,1,2}\dot{\theta}_{0,1,2}\\
  &\dot{x}_{3}= \dot{x}_{r}-L_0C_{0}\dot{\theta}_{0}+l_3C_{0,3}\dot{\theta}_{0,3}\\
  &\dot{y}_{3}= \dot{y}_{r}-L_0S_{0}\dot{\theta}_{0}+l_3S_{0,3}\dot{\theta}_{0,3}\\
  &\dot{x}_{4}= \dot{x}_{r}-L_0C_{0}\dot{\theta}_{0}+L_3C_{0,3}\dot{\theta}_{0,3}+l_4C_{0,3,4}\dot{\theta}_{0,3,4}\\
  &\dot{y}_{4}= \dot{y}_{r}-L_0S_{0}\dot{\theta}_{0}+L_3S_{0,3}\dot{\theta}_{0,3}+l_4S_{0,3,4}\dot{\theta}_{0,3,4}\\
  \end{aligned}
  \right.
  $$

- **x0,z0 in hip and $$\theta_{hhip} = \theta_b+\theta_{hip}$$**

$$
\begin{bmatrix}
\mathrm{M}_{b,b} &\mathrm{M}_{b,lg} &\mathrm{M}_{b,la}\\
\mathrm{M}^T_{b,lg} &\mathrm{M}_{lg,lg} &\mathrm{0}\\
\mathrm{M}^T_{b,la} &\mathrm{0} &\mathrm{M}_{la,la}\\
\end{bmatrix}
\begin{bmatrix}
\ddot{x}\\
\ddot{y}\\
\ddot{\theta}_{lg1}\\
\ddot{\theta}_{lg2}\\
\ddot{\theta}_{la1}\\
\ddot{\theta}_{la2}\\
\end{bmatrix}
+
\begin{bmatrix}
\mathrm{G}_{b}\\
\mathrm{G}_{lg}\\
\mathrm{G}_{la}\\
\end{bmatrix}g
+
\begin{bmatrix}
\mathrm{C}_b\\
\mathrm{C}_{lg}\\
\mathrm{C}_{la}\\
\end{bmatrix}
=
\begin{bmatrix}
0 \\ 0 \\ \tau_{b} \\ \tau_{lg1} \\ \tau_{lg2} \\ 
\tau_{la1} \\ \tau_{la2}\\
\end{bmatrix}
+
\begin{bmatrix}
\mathrm{J}_l &\mathrm{J}_r
\end{bmatrix}
\begin{bmatrix}
F_{lx} \\ F_{ly}
\end{bmatrix}
$$

- 惯量项

$$
\begin{aligned}
&m_{xc\theta}=-L_0C_0(m_3+m_4)-m_0l_0C_0+\displaystyle\sum_{k=lg,la}
(m_{k2}L_{k1}C_{0,k1}+m_{k1}l_{k1}C_{0,k1}+m_{k2}l_{k2}C_{0,k1,k2})\\
&m_{xs\theta}=-L_0S_0(m_1+m_2)-m_0l_0S_0+\displaystyle\sum_{k=lg,la}
(m_{k2}L_{k1}S_{0,k1}+m_{k1}l_{k1}S_{0,k1}+m_{k2}l_{k2}S_{0,k1,k2})\\
&m_{x\theta\theta}=\hat{I}_{0,1,2,3,4}+L_0^2(m_3+m_4)+L_1^2m_2+L_3^2m_4-\\
&2L_0L_3m_4C_3-2L_0l_3m_3C_3-2L_0l_4m_4C_{3,4}+2L_1l_2m_2C_2+2L_3l_4m_4C_4\\
\\
&\mathrm{M}_{b,b} =
\begin{bmatrix}
m_{0,1,2,3,4} &0 &m_{xc\theta}\\
0 &m_{0,1,2,3,4} &m_{xs\theta}\\
m_{xc\theta} &m_{xs\theta} &m_{x\theta\theta}\\
\end{bmatrix}\\
\\
&\mathrm{M}_{b,lg} =
\begin{bmatrix}
m_2L_1C_{0,lg1}+m_1l_1C_{0,lg1}+m_2l_2C_{0,lg1,lg2} &m_2l_2C_{0,lg1,lg2}\\
m_2L_1S_{0,lg1}+m_1l_1S_{0,lg1}+m_2l_2S_{0,lg1,lg2} &m_2l_2S_{0,lg1,lg2}\\
\hat{I}_1+\hat{I}_2+m_2L^2_1+2m_2l_{2}L_1C_{lg2} &\hat{I}_2+m_2l_{2}L_1C_{lg2}
\end{bmatrix} \\
\\

&\mathrm{M}_{b,la} =
\begin{bmatrix}
m_4L_3C_{0,la1}+m_3l_3C_{0,la1}+m_4l_4C_{0,la1,la2} &m_4l_4C_{0,la1,la2}\\
m_4L_3S_{0,la1}+m_3l_3S_{0,la1}+m_4l_4S_{0,la1,la2} &m_4l_4S_{0,la1,la2}\\
\hat{I}_3+\hat{I}_4+L_3^2m_4+2L_3l_4m_4C_{la2}-L_0L_3m_4C_{la1}-L_0l_3m_3C_{la1}-L_0l_4m_4C_{la1,la2}
&\hat{I}_4+L_3l_4m_4C_{la2}-L_0l_4m_4C_{la1,la2}
\end{bmatrix} \\
\\

&\mathrm{M}_{lg,lg}=
\begin{bmatrix}
\hat{I}_1+\hat{I}_2+m_2L^2_1+2m_2l_{2}L_1C_{lg2} &\hat{I}_2+m_2l_{2}L_1C_{lg2}\\
\hat{I}_2+m_2l_{2}L_1C_{lg2} &\hat{I}_2
\end{bmatrix}\\
\\

&\mathrm{M}_{la,la}=
\begin{bmatrix}
\hat{I}_3+\hat{I}_4+m_4L^2_3+2m_4L_3l_4C_{la2} &\hat{I}_4+m_4L_3l_4C_{la2}\\
\hat{I}_4+m_4L_3l_4C_{la2} &\hat{I}_4
\end{bmatrix}\\
\\

\end{aligned}
$$

- 重力项

$$
\begin{aligned}
&\mathrm{G}_b =
\begin{bmatrix}
0 \\ m_{0,1,2,3,4}\\
m_{xs\theta}
\end{bmatrix}\\
\\
&\mathrm{G}_{lg} =
\begin{bmatrix}
(m_2L_1+m_1l_1)S_{0,lg1}+m_2l_2S_{0,lg1,lg2} \\
m_2l_2S_{0,lg1,lg2}
\end{bmatrix}\\
\\
&\mathrm{G}_{la} =
\begin{bmatrix}
(m_4L_3+m_3l_3)S_{0,la1}+m_4l_4S_{0,la1,la2} \\
m_4l_4S_{0,la1,la2}
\end{bmatrix}\\

\end{aligned}
$$

- 离心力项

$$
\begin{aligned}
&m_{bs\theta} = L_0S_0(m_3+m_4)+m_0l_0S_0-\displaystyle\sum_{k=lg,la}(L_{k1}m_{k2}S_{0,k1}+l_{k1}m_{k1}S_{0,k1}+l_{k2}m_{k2}S_{0,k1,k2})\\
\\
&m_{odd,s\theta}=L_{k1}m_{k2}S_{0,k1}+l_{k1}m_{k1}S_{0,k1}+l_{k2}m_{k2}S_{0,k1,k2}\\
\\
&m_{odd,sg\theta}=L_{k1}m_{k2}S_{k1}+l_{k1}m_{k1}S_{k1}+l_{k2}m_{k2}S_{k1,k2}\\
\\
&m_{eve,s\theta}=l_{k2}m_{k2}S_{0,k1,k2}\\
\\
&m_{eve,sg\theta}=l_{k2}m_{k2}S_{k1,k2}\\
\\
&m_{s\theta\theta1}=L_0(L_{k1}m_{k2}S_{k1}+l_{k1}m_{k1}S_{k1}+l_{k2}m_{k2}S_{k1,k2})\\
\\
&m_{s\theta\theta2}=m_{k2}l_{k2}(L_0S_{k1,k2}-L_{k1}S_{k2})\\
\\
&m_{s\theta\theta3}=m_{k2}l_{k2}L_{k1}S_{k2}\\
\\
&\mathrm{C}_b=
\begin{bmatrix}
(m_{bs\theta})\dot{\theta}_0^2-
\displaystyle\sum_{k=lg,la}(2m_{odd,s\theta}\dot{\theta}_0\dot{\theta}_{k1}+2m_{eve,s\theta}\dot{\theta}_0\dot{\theta}_{k2}+
m_{odd,s\theta}\dot{\theta}_{k1}^2+m_{eve,s\theta}\dot{\theta}_{k2}^2+2m_{eve,s\theta}\dot{\theta}_{k1}\dot{\theta}_{k2})\\
-(m_{bc\theta})\dot{\theta}_0^2+
\displaystyle\sum_{k=lg,la}(2m_{odd,c\theta}\dot{\theta}_0\dot{\theta}_{k1}+2m_{eve,c\theta}\dot{\theta}_0\dot{\theta}_{k2}+
m_{odd,c\theta}\dot{\theta}_{k1}^2+m_{eve,c\theta}\dot{\theta}_{k2}^2+2m_{odd,c\theta}\dot{\theta}_{k1}\dot{\theta}_{k2})\\
\displaystyle\sum_{k=la}(2m_{s\theta\theta1}\dot{\theta}_0\dot{\theta}_{k1}+2m_{s\theta\theta2}\dot{\theta}_0\dot{\theta}_{k2}+m_{s\theta\theta1}\dot{\theta}_{k1}^2+m_{s\theta\theta2}\dot{\theta}_{k2}^2+2m_{s\theta\theta2}\dot{\theta}_{k1}\dot{\theta}_{k2})-\displaystyle\sum_{k=lg}(2m_{s\theta\theta3}\dot{\theta}_0\dot{\theta}_{k2}+2m_{s\theta\theta3}\dot{\theta}_{k1}\dot{\theta}_{k2}+m_{s\theta\theta3}\dot{\theta}_{k2}^2)
\end{bmatrix}\\
\\
&\mathrm{C}_{lg}=
\begin{bmatrix}
-2m_{s\theta\theta3,lg}\dot{\theta}_{0}\dot{\theta}_{k2,lg}-2m_{s\theta\theta3,lg}\dot{\theta}_{k1,lg}\dot{\theta}_{k2,la}-m_{s\theta\theta3,lg}\dot{\theta}_{k2,lg}^2\\
m_{s\theta\theta3,lg}\dot{\theta}_{0}^2+2m_{s\theta\theta3,lg}\dot{\theta}_0\dot{\theta}_{k1,lg}+m_{s\theta\theta3,lg}\dot{\theta}_{k1,lg}^2
\end{bmatrix}\\
\\
&\mathrm{C}_{la}=
\begin{bmatrix}
-m_{s\theta\theta1,la}\dot{\theta}_0^2-2m_{s\theta\theta3,la}\dot{\theta}_0\dot{\theta}_{k2,la}-2m_{s\theta\theta3,la}\dot{\theta}_{k1,la}\dot{\theta}_{k2,la}-m_{s\theta\theta3,la}\dot{\theta}_{k2,la}^2\\
-m_{s\theta\theta2,la}\dot{\theta}_0^2+2m_{s\theta\theta3,la}\dot{\theta}_0\dot{\theta}_{k1,la}+m_{s\theta\theta3,la}\dot{\theta}_{k1,la}^2
\end{bmatrix}\\
\\
\end{aligned}
$$



##### 半身动力学3

- 从上到下的多杆倒立摆动力学方程建模方法
  $$
  \begin{bmatrix}
  \mathrm{M}_{b,b} &\mathrm{M}_{b,lg} &\mathrm{M}_{b,la}\\
  \mathrm{M}^T_{b,lg} &\mathrm{M}_{lg,lg} &\mathrm{0}\\
  \mathrm{M}^T_{b,la} &\mathrm{0} &\mathrm{M}_{la,la}\\
  \end{bmatrix}
  \begin{bmatrix}
  \ddot{\theta}_{lg1}\\
  \ddot{\theta}_{lg2}\\
  \ddot{\theta}_{la1}\\
  \ddot{\theta}_{la2}\\
  \end{bmatrix}
  +
  \begin{bmatrix}
  \mathrm{G}_{b}\\
  \mathrm{G}_{lg}\\
  \mathrm{G}_{la}\\
  \end{bmatrix}g
  +
  \begin{bmatrix}
  \mathrm{C}_b\\
  \mathrm{C}_{lg}\\
  \mathrm{C}_{la}\\
  \end{bmatrix}
  =
  \begin{bmatrix}
  \tau_{b} \\ \tau_{lg1} \\ \tau_{lg2} \\ 
  \tau_{la1} \\ \tau_{la2}\\
  \end{bmatrix}
  $$

- 惯量项
  $$
  
  $$
  





#### Model_Jin+双单摆臂

##### 不同速度下数据对比

- 动力学方程
  $$
  \begin{bmatrix}
  \mathrm{M}_{b,b} &\mathrm{M}_{b,lg} &\mathrm{M}_{b,rg} &\mathrm{M}_{b,la} &\mathrm{M}_{b,ra}\\
  \mathrm{M}^T_{b,lg} &\mathrm{M}_{lg,lg} &\mathrm{0} &\mathrm{0} &\mathrm{0}\\
  \mathrm{M}^T_{b,rg} &\mathrm{0} &\mathrm{M}_{rg,rg} &\mathrm{0} &\mathrm{0}\\
  \mathrm{M}^T_{b,la} &\mathrm{0} &\mathrm{0}&\mathrm{M}_{la,la} &\mathrm{0}\\
  \mathrm{M}^T_{b,ra} &\mathrm{0} &\mathrm{0} &\mathrm{0} &\mathrm{M}_{ra,ra}\\
  \end{bmatrix}
  \begin{bmatrix}
  \ddot{x}\\
  \ddot{y}\\
  \ddot{\theta}_{lg1}\\
  \ddot{\theta}_{lg2}\\
  \ddot{\theta}_{rg1}\\
  \ddot{\theta}_{rg2}\\
  \ddot{\theta}_{la}\\
  \ddot{\theta}_{ra}\\
  \end{bmatrix}
  +
  \begin{bmatrix}
  \mathrm{G}_{b}\\
  \mathrm{G}_{lg}\\
  \mathrm{G}_{rg}\\
  \mathrm{G}_{la}\\
  \mathrm{G}_{ra}\\
  \end{bmatrix}g
  +
  \begin{bmatrix}
  \mathrm{C}_b\\
  \mathrm{C}_{lg}\\
  \mathrm{C}_{rg}\\
  \mathrm{C}_{la}\\
  \mathrm{C}_{ra}\\
  \end{bmatrix}
  =
  \begin{bmatrix}
  0 \\ 0 \\ \tau_{lg1} \\ \tau_{lg2} \\ \tau_{rg1} \\ \tau_{rg2 }\\ \tau_{la} \\ \tau_{ra}
  \end{bmatrix}
  +
  \begin{bmatrix}
  \mathrm{J}_l &\mathrm{J}_r
  \end{bmatrix}
  \begin{bmatrix}
  F_{lx} \\ F_{ly} \\ F_{rx} \\ F_{ry}
  \end{bmatrix}
  $$

  $$
  
  $$

  ![Compare_force_BB_aim10](https://s2.loli.net/2022/07/11/kpRrAz8K7xoZOaw.png)

- 轨迹优化
  $$
  \begin{aligned}
  &\min_{dt,q_i,\dot{q}_i,\tau_i,F_i}{\sum^n_{i=0}(\max{(\dot{q}\tau dt,0)}+\lvert \tau_i \rvert+\lvert F_i\rvert)+\lvert \frac{x_n-x_0}{v_{target}\cdot ndt} \rvert}\\
  &\quad\quad s.t.\quad
  
  \begin{aligned}
  &\color{Crimson}{\left\{
      \begin{aligned}
      &q_{i+1}-q_i-\frac{dt}{2}(\dot{q}_{i+1}+\dot{q}_{i})=0\\
      &M(q_i)(\dot{q}_{i+1}-\dot{q}_i)+F(q_i,\dot{q_i+1})dt-\tau_i dt-J^(q_i)F_idt=0\\
      \end{aligned}
  \right.} &\color{Crimson}{Dynamics}\\
  &\color{Coral}{\left\{
  \begin{aligned}
  &\left\{
      \begin{aligned}
      &\phi_y(q_i)=0\\
      &F_y\mu-\lvert F_x \rvert\ge0\\
      &\dot{\phi}_x(q_i,\dot{q}_i)=0
      \end{aligned}\ stance\ phase
  \right.\\
  &\left\{
      \begin{aligned}
      &\phi_y(q_i)\ge0\\
      &F_{xi}=0\\
      &F_{yi}=0
      \end{aligned}\quad \quad swing\ phase
  \right.
  \end{aligned}
  \right.} &\color{Coral}{Contact}\\
  &\color{LightSeaGreen}{\left\{
      \begin{aligned}
      &q_0-q_n=0\quad(except\ x)\\
      &\dot{q}_0-\dot{q}_n=0\\
      &\ddot{q}_0-\ddot{q}_n=0
      \end{aligned}
  \right.} &\color{LightSeaGreen}{Preiodic}\\
  &\color{DodgerBlue}{\left\{
      \begin{aligned}
      &\underline{q}\le q \le \bar{q}\\
      &\underline{\dot{q}} \le \dot{q} \le \bar{\dot{q}}\\
      &\underline{\tau}(\dot{q})\le \tau \le \bar{\tau}(\dot{q})\\
      \end{aligned}
  \right.} &\color{DodgerBlue}{Boundary}\\
  \end{aligned}
  
  \end{aligned}
  $$
  

| 参数                                                         | 数据图                                                       |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| - Vt = 2, Pc = 0, Fc = 0.6, Sc = 0.2, Ic = 0.2<br />（arm swing） | <img src="https://s2.loli.net/2022/07/06/u1M52LFkqjCHdoc.png" alt="Traj-Vel-uF" style="zoom:40%;" /><br />2022-07-02-19-52-57-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_2-Tp_0.4-Tst_0.4-config.yaml |
| - Vt = 2, Pc = 0, Fc = 0.6, Sc = 0.2, Ic = 0.2<br />（arm bound） | <img src="https://s2.loli.net/2022/07/06/bFhstCV5Q1OZocm.png" alt="Traj-Vel-uF" style="zoom: 40%;" /><br />2022-07-06-10-21-56-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_2-Tp_0.4-Tst_0.4-config.yaml |
| Vt = 5, Pc = 0, Fc = 0.6, Sc = 0.2, Ic = 0.2<br />（arm swing） | <img src="https://s2.loli.net/2022/07/06/7x6gGhwztNUQARm.png" alt="Traj-Vel-uF" style="zoom:50%;" /><br />2022-07-06-09-30-18-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_5-Tp_0.26-Tst_0.3-config.yaml |
| Vt = 5, Pc = 0, Fc = 0.6, Sc = 0.2, Ic = 0.2<br />（arm bound） | <img src="https://s2.loli.net/2022/07/06/TcqvXm1BwySzYVk.png" alt="Traj-Vel-uF" style="zoom:50%;" /><br />2022-07-06-09-29-45-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_5-Tp_0.26-Tst_0.3-config.yaml |
| Vt = 10, Pc = 0, Fc = 0.6, Sc = 0.2, Ic = 0.2<br />（arm swing） | <img src="https://s2.loli.net/2022/07/06/HZXLBQWsaCNfbpA.png" alt="Traj-Vel-uF" style="zoom:40%;" /><br />2022-07-06-10-26-25-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_10-Tp_0.2-Tst_0.26-config.yaml |
| Vt = 10, Pc = 0, Fc = 0.6, Sc = 0.2, Ic = 0.2<br />（arm bound） | <img src="https://s2.loli.net/2022/07/06/3R2PJo7BnXQkEGO.png" alt="Traj-Vel-uF" style="zoom:40%;" /><br />2022-07-06-10-27-03-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_10-Tp_0.2-Tst_0.26-config.yaml |





- **不同速度下运动数据和动力学分析**

| 参数                                                         | 数据图                                                       |                                                              |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Vt = 5, Pc = 0, Fc = 0.6, Sc = 0.2, Ic = 0.2<br />（arm swing） | 2022-07-13-11-57-05-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_5-Tp_0.26-Tst_0.3-config.yaml |                                                              |
|                                                              | <img src="https://s2.loli.net/2022/07/13/YwqnA2EHiO6LGmf.png" alt="Traj" style="zoom: 20%;" /> | <img src="https://s2.loli.net/2022/07/13/repABCF8uVRHNz3.png" alt="Pos-Vel-uF" style="zoom: 67%;" /> |
|                                                              | <img src="https://s2.loli.net/2022/07/13/OjPTxwYQ3mEIXol.png" alt="dynamics-eq" style="zoom: 67%;" /> |                                                              |
| Vt = 5, Pc = 0, Fc = 0.6, Sc = 0.2, Ic = 0.2<br />（arm bound） | 2022-07-13-11-57-05-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_5-Tp_0.26-Tst_0.3-config.yaml |                                                              |
|                                                              | <img src="https://s2.loli.net/2022/07/13/eH1QzoFAlWigKcV.png" alt="Traj" style="zoom:25%;" /> | <img src="https://s2.loli.net/2022/07/13/Jtk43UAy1rE7eNS.png" alt="Pos-Vel-uF" style="zoom:67%;" /> |
|                                                              | <img src="https://s2.loli.net/2022/07/13/sgoZUbl37Y6CJwS.png" alt="dynamics-eq" style="zoom:67%;" /> |                                                              |



- **不同速度下运动数据**

  采用人的不太频率和接触占比，修改手臂长度

  | 速度        | Arm swing                                                    | Arm bound                                                    |
  | ----------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
  | Vt = 2 m/s  | ![Traj](https://s2.loli.net/2022/07/25/YKHbwWiJnOczpQU.png)<br />2022-07-24-19-05-18-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_2-Tp_0.53-Tst_0.45-config.yaml | <img src="https://s2.loli.net/2022/07/25/Dc7oP3srC9fhwGF.png" alt="Traj" style="zoom: 30%;" /><br />2022-07-24-19-06-03-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_2-Tp_0.53-Tst_0.45-config.yaml |
  |             | ![Pos-Vel-uF](https://s2.loli.net/2022/07/25/uZJ5DSYp73kgK8t.png) | <img src="https://s2.loli.net/2022/07/25/ZJNyoLr8Ek1KmdM.png" alt="Pos-Vel-uF" style="zoom:33%;" /> |
  | Vt = 3 m/s  | ![Traj](https://s2.loli.net/2022/07/25/dRB6gor9C2PfL5A.png)<br />2022-07-24-19-10-34-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_3-Tp_0.46-Tst_0.41-config.yaml | <img src="https://s2.loli.net/2022/07/25/tLUGFx3WcyinCj4.png" alt="Traj" style="zoom:33%;" /><br />2022-07-24-19-11-26-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_3-Tp_0.46-Tst_0.41-config.yaml |
  |             | ![Pos-Vel-uF](https://s2.loli.net/2022/07/25/M4kGut23JPAUnHO.png) | <img src="https://s2.loli.net/2022/07/25/7Zepi9XtVwGKqEu.png" alt="Pos-Vel-uF" style="zoom:33%;" /> |
  | Vt = 4 m/s  | ![Traj](https://s2.loli.net/2022/07/25/xaZO7XHlcCzeQ1g.png)<br />2022-07-24-19-21-09-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_4-Tp_0.46-Tst_0.37-config.yaml | <img src="https://s2.loli.net/2022/07/25/z1FSRWy98imwjZl.png" alt="Traj" style="zoom:33%;" /><br />2022-07-24-19-22-03-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_4-Tp_0.46-Tst_0.37-config.yaml |
  |             | ![Pos-Vel-uF](https://s2.loli.net/2022/07/25/Yl1CDdERUQeV5yN.png) | <img src="https://s2.loli.net/2022/07/25/5W348NwLQRfI1UT.png" alt="Pos-Vel-uF" style="zoom:33%;" /> |
  | Vt = 5 m/s  | ![Traj](https://s2.loli.net/2022/07/25/OaVNeLYJDdFTf7E.png)<br />2022-07-24-19-23-07-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_5-Tp_0.4-Tst_0.34-config.yaml | <img src="https://s2.loli.net/2022/07/25/6eIy7gHhXvmCTa1.png" alt="Traj" style="zoom:33%;" /><br />2022-07-24-19-23-53-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_5-Tp_0.4-Tst_0.34-config.yaml |
  |             | ![Pos-Vel-uF](https://s2.loli.net/2022/07/25/ntUrEHxDQvp2w3S.png) | <img src="https://s2.loli.net/2022/07/25/3SvCaZnOc6yBKXI.png" alt="Pos-Vel-uF" style="zoom:33%;" /> |
  | Vt = 6 m/s  | ![Traj](https://s2.loli.net/2022/07/25/F7VE6TloCBwAi5s.png)<br />2022-07-24-19-24-56-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_6-Tp_0.4-Tst_0.35-config.yaml | <img src="https://s2.loli.net/2022/07/25/lo5HkdvmRM6VCDy.png" alt="Traj" style="zoom:33%;" /><br />2022-07-24-19-26-48-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_6-Tp_0.4-Tst_0.35-config.yaml |
  |             | ![Pos-Vel-uF](https://s2.loli.net/2022/07/25/MPKnQqR6GkJh2XH.png) | <img src="https://s2.loli.net/2022/07/25/LZQbcWdfvx3zw8j.png" alt="Pos-Vel-uF" style="zoom:33%;" /> |
  | Vt = 7 m/s  | ![Traj](https://s2.loli.net/2022/07/25/I5VdiujpK2zUf3A.png)<br />2022-07-24-19-28-23-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_7-Tp_0.4-Tst_0.32-config.yaml | <img src="https://s2.loli.net/2022/07/25/orYtyWGvA6SUP8u.png" alt="Traj" style="zoom:33%;" /><br />2022-07-24-19-29-28-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_7-Tp_0.4-Tst_0.32-config.yaml |
  |             | ![Pos-Vel-uF](https://s2.loli.net/2022/07/25/tBlhaFdZeIqCmkO.png) | <img src="https://s2.loli.net/2022/07/25/JYQNlmHTgPFSskK.png" alt="Pos-Vel-uF" style="zoom:33%;" /> |
  | Vt = 8 m/s  | ![Traj](https://s2.loli.net/2022/07/25/VRHjSiTe1QdKDGw.png)<br />2022-07-24-19-30-37-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_8-Tp_0.35-Tst_0.25-config.yaml | <img src="https://s2.loli.net/2022/07/25/yvZ6qbtFcjA9BLi.png" alt="Traj" style="zoom:33%;" />br /><bar/>2022-07-24-19-31-20-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_8-Tp_0.35-Tst_0.25-config.yaml |
  |             | ![Pos-Vel-uF](https://s2.loli.net/2022/07/25/V8l4IAzuj2xoN6T.png) | <img src="https://s2.loli.net/2022/07/25/buCqJygjBktH9IZ.png" alt="Pos-Vel-uF" style="zoom:33%;" /> |
  | Vt = 9 m/s  | ![Traj](https://s2.loli.net/2022/07/25/GTz83AnUePK6a2o.png)<br />2022-07-24-19-32-23-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_9-Tp_0.35-Tst_0.24-config.yaml | ![Traj](https://s2.loli.net/2022/07/25/bxOPvBqdRCrlmUy.png)<br />2022-07-24-19-33-06-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_9-Tp_0.35-Tst_0.24-config.yaml |
  |             | ![Pos-Vel-uF](https://s2.loli.net/2022/07/25/PXpiNnUmDEqKueO.png) | ![Pos-Vel-uF](https://s2.loli.net/2022/07/25/fZvIaBrMyhjTx1e.png) |
  | Vt = 10 m/s | ![Traj](https://s2.loli.net/2022/07/25/udiDspt6YCAH3bO.png)<br/>2022-07-24-19-34-40-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_10-Tp_0.35-Tst_0.23 | ![Traj](https://s2.loli.net/2022/07/25/eRCQyBzVLFgJp1h.png)<br/>2022-07-24-19-35-25-Traj-Tcf_0.0-Pcf_0.0-Fcf_0.6-Scf_0.2-Icf_0.2-Vt_10-Tp_0.35-Tst_0.23 |
  |             | ![Pos-Vel-uF](https://s2.loli.net/2022/07/25/xh2ZMKGkT9A3lCb.png) | ![Pos-Vel-uF](https://s2.loli.net/2022/07/25/l1RBfauyUP7EtOF.png) |
  
  - 结果分析：当<font color = 'red'>速度小于4 m/s时，手臂摆动对力和力矩的影响非常小</font>，可以忽略不计
  
    
  
- **不同速度对力和力矩的影响**

  | 速度   | Stance(占比) | T      |
  | ------ | ------------ | ------ |
  | 2 m/s  | 0.45         | 0.53 s |
  | 3 m/s  | 0.41         | 0.46 s |
  | 4 m/s  | 0.37         | 0.46 s |
  | 5 m/s  | 0.34         | 0.40 s |
  | 6 m/s  | 0.35         | 0.40 s |
  | 7 m/s  | 0.32         | 0.40 s |
  | 8 m/s  | 0.25         | 0.35 s |
  | 9 m/s  | 0.24         | 0.35 s |
  | 10 m/s | 0.23         | 0.35 s |

  <img src="https://s2.loli.net/2022/07/25/GDhnURxFjHAgOJq.png" alt="Vel-Force" style="zoom:67%;" />

  - 结果分析：臂摆动时，<font color = 'red'>速度越高，Hip关节力矩越大，对整体趋势而言，足底力Fy和Knee关节力矩越大</font>，虽然存在波动，但是波动可能由于运动周期T的选择有关

  

- **8 m/s时不同步态频率的影响**

  | 周期 T: 0.35 s                                               | 周期 T: 0.50 s                                               |
  | ------------------------------------------------------------ | ------------------------------------------------------------ |
  | Period: 0.35      Stance: 0.25                               | Period: 0.49      Stance: 0.28                               |
  | <img src="https://s2.loli.net/2022/07/25/VRHjSiTe1QdKDGw.png" alt="Traj" style="zoom:33%;" /> | <img src="https://s2.loli.net/2022/07/25/so5EBfIWQ6S1rgO.png" alt="Traj" style="zoom:33%;" /> |
  | <img src="https://s2.loli.net/2022/07/25/V8l4IAzuj2xoN6T.png" alt="Pos-Vel-uF" style="zoom:33%;" /> | <img src="https://s2.loli.net/2022/07/25/HzGguCOhtxAUa8j.png" alt="Pos-Vel-uF" style="zoom:33%;" /> |
  | <img src="https://s2.loli.net/2022/07/25/ZeHgK7s6GrU38Mf.png" alt="dyanmics-arm-0.35" style="zoom:33%;" /> | <img src="https://s2.loli.net/2022/07/25/dkV15CDq6nyRjYA.png" alt="dyanmics-arm-0.49" style="zoom:33%;" /> |
  | <img src="https://s2.loli.net/2022/07/25/yvZ6qbtFcjA9BLi.png" alt="Traj" style="zoom:33%;" />br /> | <img src="https://s2.loli.net/2022/07/25/f5RkxDoiqZ84sVu.png" alt="Traj" style="zoom:33%;" /> |
  | <img src="https://s2.loli.net/2022/07/25/buCqJygjBktH9IZ.png" alt="Pos-Vel-uF" style="zoom:33%;" /> | <img src="https://s2.loli.net/2022/07/25/89u2JZNasB4MEDG.png" alt="Pos-Vel-uF" style="zoom:33%;" /> |

  - 结果分析：
    - 采用<font color = 'red'>人体运动频率</font>时，臂摆动相对于束缚，<font color = 'red'>足底力和关节力矩变化不大</font>
    - 运动<font color = 'red'>频率越高</font>，手臂的<font color = 'red'>耦合作用效果越明显</font>。
    - 为了充分发挥手臂的耦合作用，相比较于人体的运动频率，<font color = 'red'>机器人的运动频率需要更高</font>。



- **8 m/s时不同的质量和惯量对力和力矩的影响**

  <img src="https://s2.loli.net/2022/07/25/9Pya2fZXnWJ5LhR.png" alt="ForceMap2" style="zoom: 80%;" />

  ![Figure_1](https://s2.loli.net/2022/07/27/78pcVXgUjDtSaof.png)

  - 结果分析： 从质量分布图中，难以获得非常明显的规律和信息，金师兄说可以考虑不用<font color = 'red'>峰值数据，而是均值数据</font>

    <font color='DeepSkyBlue' size='6'>(^o^ !)嘿嘿，质量分布图初步结果总算有了，不管结果如何，已经迈出了巨大的一步， 加油！！！</font>
  
  
  
  - 基于均值数据的惯性参数-力分布图
  
    ![ForceMap11-MV](https://s2.loli.net/2022/07/28/8Enbd7iRJc4ygmo.png)
  
    ![ForceMap11-MV2](https://s2.loli.net/2022/07/29/TZPSVMYIArOU92d.png)
  
  

##### 稳定恢复数据对比

- 控制器
  $$
  \begin{aligned}
  &\min_{q_i,\dot{q}_i,\tau_i,F_i}{\sum^n_{i=0}(\max{(\dot{q}\tau dt,0)}+\lvert \tau_i \rvert+\lvert F_i\rvert+\lvert q_i-q_{tar} \rvert)}\\
  &\quad\quad s.t.\quad
  
  \begin{aligned}
  &\color{Crimson}{\left\{
      \begin{aligned}
      &q_{i+1}-q_i-\frac{dt}{2}(\dot{q}_{i+1}+\dot{q}_{i})=0\\
      &M(q_i)(\dot{q}_{i+1}-\dot{q}_i)+F(q_i,\dot{q_i+1})dt-\tau_i dt-J^(q_i)F_idt=0\\
      \end{aligned}
  \right.} &\color{Crimson}{Dynamics}\\
  &\color{Coral}{\left\{
  \begin{aligned}
  &F_z\mu-\lvert F_x \rvert\ge0\\
  &x_{lf,rf}=0\\
  &z_{lf,rf}=0
  \end{aligned}
  \right.} &\color{Coral}{Contact}\\
  &\color{DodgerBlue}{\left\{
      \begin{aligned}
      &q_0=q_{init}\\
      &\underline{q}\le q \le \bar{q}\\
      &\underline{\dot{q}} \le \dot{q} \le \bar{\dot{q}}\\
      &\underline{\tau}(\dot{q})\le \tau \le \bar{\tau}(\dot{q})\\
      \end{aligned}
  \right.} &\color{DodgerBlue}{Boundary}\\
  \end{aligned}
  
  \end{aligned}
  $$
  
###### 优化轨迹求解结果
- ankle不含力矩结果

  | 角度 | 手臂自由   | 手臂束缚 |
  | ---- | ---------------------- | -------- |
  | 9°| <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/bal4-arm-traj-9-2022-08-23-20-11-12.png" alt="bal4-arm-traj-9-2022-08-23-20-11-12"> | |
  | | <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/bal4-arm-9-2022-08-23-20-11-49.png" alt="bal4-arm-9-2022-08-23-20-11-49"> | |
  | 6°   | <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/bal4-arm-traj-6-2022-08-23-15-53-42.png" alt="bal4-arm-traj-6-2022-08-23-15-53-42"> |  <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/bal4-noarm-traj-6-2022-08-23-15-53-55.png" alt="bal4-noarm-traj-6-2022-08-23-15-53-55"> |
  |  | <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/bal4-arm-6-2022-08-23-15-54-08.png" alt="bal4-arm-6-2022-08-23-15-54-08"> | <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/bal4-noarm-6-2022-08-23-15-54-21.png" alt="bal4-noarm-6-2022-08-23-15-54-21"> |
  | 3° | <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/bal4-arm-traj-3-2022-08-23-14-42-00.png" alt="bal4-arm-traj-3-2022-08-23-14-42-00"> |     <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/bal4-noarm-3-2022-08-23-14-42-25.png" alt="bal4-noarm-3-2022-08-23-14-42-25">     |
  | |   <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/bal4-arm-3-2022-08-23-14-42-14.png" alt="bal4-arm-3-2022-08-23-14-42-14">   |                            <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/bal4-noarm-traj-3-2022-08-23-14-42-36.png" alt="bal4-noarm-traj-3-2022-08-23-14-42-36">                                  |
  
- ankle含有力矩的结果

  |      |                                                              |                                                              |
  | ---- | ------------------------------------------------------------ | ------------------------------------------------------------ |
  | 角度 | 手臂自由                                                     | 手臂束缚                                                     |
  | 5° | T: 2.0     dt: 0.002<br /><br />Pf: 0.5    Vf: 0.2     Ff: 0.3<br />Pf = [50, 30, 15, 5, 5]<br />Vf = [40, 20, 10, 5, 5]<br />Ff = [30, 20, 10, 5, 5]   100    500<br />Tor_ankle: 15<br />2022-08-29-18-24-53-Traj-Tcf_0.5-Pcf_0.0-Fcf_0.3-Scf_0.0-Icf_0.0-Vt_5-Tp_2.0-Ang_0.087 | 2022-08-29-18-20-07-Traj-Tcf_0.5-Pcf_0.0-Fcf_0.3-Scf_0.0-Icf_0.0-Vt_5-Tp_2.0-Ang_0.087 |
  |  | <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Traj-2022-08-30-09-21-40.jpg" alt="Traj-2022-08-30-09-21-40"> | <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Traj-2022-08-30-09-21-53.jpg" alt="Traj-2022-08-30-09-21-53"> |
  |  | <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Fy-2022-08-30-09-22-24.jpg" alt="Fy-2022-08-30-09-22-24"> | <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Fy-2022-08-30-09-22-33.jpg" alt="Fy-2022-08-30-09-22-33"> |
  |  | <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Pos-Vel-uF-2022-08-30-09-23-17.jpg" alt="Pos-Vel-uF-2022-08-30-09-23-17"> | <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Pos-Vel-uF-2022-08-30-09-23-32.jpg" alt="Pos-Vel-uF-2022-08-30-09-23-32"> |
  |  | <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/dynamics-eq5-2022-08-30-10-01-28.png" alt="dynamics-eq5-2022-08-30-10-01-28"> |  <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/dynamics-eq5-2022-08-30-10-01-41.png" alt="dynamics-eq5-2022-08-30-10-01-41">|
  | 4.5° | T: 1.0     dt: 0.001<br /><br />Pf: 0.8    Vf: 0.1     Ff: 0.1<br />Pf = [80, 10, 15, 5, 0.2]<br />Vf = [40, 5, 10, 5, 5]<br />Ff = [30, 10, 10, 5, 1]   50    200<br />Tor_ankle: 20 | 2022-09-06-20-32-30-Traj-Tcf_0.8-Pcf_0.0-Fcf_0.1-Scf_0.0-Icf_0.0-Vt_5-Tp_1.0-Ang_0.079                                                             |
  |      | <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Traj-2022-09-06-20-46-37.jpg" alt="Traj-2022-09-06-20-46-37"> | |
  |      | <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Pos-Vel-uF-2022-09-06-20-46-59.jpg" alt="Pos-Vel-uF-2022-09-06-20-46-59"> | |
  | | <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Fy-2022-09-06-20-47-37.jpg" alt="Fy-2022-09-06-20-47-37"> | |
  | 4.5° | T: 2.0     dt: 0.002<br /><br />Pf: 0.5    Vf: 0.1     Ff: 0.4<br />Pf = [50, 30, 15, 5, 5]<br />Vf = [40, 50, 10, 5, 5]<br />Ff = [50, 40, 10, 5, 5]   100    500<br />Tor_ankle: 10 |                                                              |
  |      | <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/bal3-arm-40-traj-2022-08-28-20-17-32.png" alt="bal3-arm-40-traj-2022-08-28-20-17-32"> | <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/bal3-noarm-40-traj-2022-08-28-20-17-12.png" alt="bal3-noarm-40-traj-2022-08-28-20-17-12"> |
  |      | <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/bal3-arm-40-tor-2022-08-28-20-17-47.png" alt="bal3-arm-40-tor-2022-08-28-20-17-47"> | <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/bal3-noarm-40-tor-2022-08-28-20-17-57.png" alt="bal3-noarm-40-tor-2022-08-28-20-17-57"> |
  | 3.6°   | T: 2.0     dt: 0.002<br /><br />Pf: 0.5    Vf: 0.2    Ff: 0.3<br />Pf = [50, 40, 15, 5, 5]<br />Vf = [40, 20, 10, 5, 5]<br />Ff = [30, 20, 10, 5, 5]  100    500<br />Tor_ankle: 10                                           |                                                              |
  |      | <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/bal3-arm-50-traj-2022-08-28-21-45-00.png" alt="bal3-arm-50-traj-2022-08-28-21-45-00">                                                             |  <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/bal3-noarm-50-traj-2022-08-28-21-48-59.png" alt="bal3-noarm-50-traj-2022-08-28-21-48-59">                                                            |
  |     | <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/bal3-arm-50-tor-2022-08-28-21-48-45.png" alt="bal3-arm-50-tor-2022-08-28-21-48-45">                                                             |  <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/bal3-noarm-50-tor-2022-08-28-21-48-27.png" alt="bal3-noarm-50-tor-2022-08-28-21-48-27">                                                            |
  
  - **结果分析**
    - 手臂自由相对于束缚，<font color = 'red'>knee和waist关节峰值力矩降低</font>，手臂自由运动时，Waist的运动幅度更小。但是<font color = 'red'>峰值力矩意义不大</font>，因为可以通过延长做功时间降低峰值力矩，因此峰值力矩不同但平均力矩可能差距不大。
    - 手臂自由运动时，<font color = 'red'>足底的支撑力更小</font>。同时可以看到，从开始作用到力降低到与体重等量，<font color = 'red'>手臂摆动可以延长做功和稳定恢复时间，增加身体的稳定性</font>。
    - 对于动力学过程,对于waist关节，手臂摆动时惯性力影响耦合项和主项对运动影响更大，重力项减小。
  
   
  
- 不同初始偏置角度下手臂摆动对平均力矩的影响
  - ankle 力矩限制 15
  <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Fmv15-2022-08-30-09-32-08.png" alt="Fmv15-2022-08-30-09-32-08">
  - 其他结果： 
  - ankle： 12
  <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Fmv-2022-08-30-09-31-57.png" alt="Fmv-2022-08-30-09-31-57">
  - ankle： 18
  <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Fmv18-2022-08-30-09-32-23.png" alt="Fmv18-2022-08-30-09-32-23">
  - ankle： 20
  <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Fmv20-2022-08-30-09-32-30.png" alt="Fmv20-2022-08-30-09-32-30">

  - 结果分析
    - 对于不同的ankle力矩限制和初始扰动角度，整体而言，对平均力矩影响不大。


- 不同惯量的影响
  - ankle 力矩限制 12N: 2022-09-14/ForceMap3-7-a.pkl
    ```
    Coef = [0.8, 0.1, 0.1]
    theta = pi/40
    Pf = [80, 20, 5]
    Vf = [40, 20, 5] 
    Ptar = [0, 0, np.pi]   
    Ff = [30, 10, 5]  
    50， 400
    T: 1.0    dt: 0.001
    ```
    <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/f3-7mf-2022-09-14-10-06-23.png" alt="f3-7mf-2022-09-14-10-06-23">
    <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/f3-7mf-3d-2022-09-14-10-06-32.png" alt="f3-7mf-3d-2022-09-14-10-06-32">

  - ankle 力矩限制 12N
    ```
    # control params
    Coef = [0.6, 0.1, 0.3]
    Pf = [80, 20, 5]
    Vf = [40, 20, 5]    
    Ff = [30, 10, 5]  
    Vff = 100         Pff = 500
    T: 2.0            dt: 0.002
    
    # mass and state pararms
    theta = pi/40
    Ptar = [0, 0, np.pi]
    mass: [15, 20, 6.8]
    inertia: [1.0125, 0.417, 0.09]
    index = 1.6/dt
    F[k] > F[index]*1.04 and k*dt < 1.2
    ```
    -  Free Arm: 2022-09-15/ForceMap3-7-c-arm.pkl
    <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/t-3-7-con2-2022-09-15-20-20-01.png" alt="t-3-7-con2-2022-09-15-20-20-01">
    <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/t-3-7-3d-con-2022-09-15-15-29-46.png" alt="t-3-7-3d-con-2022-09-15-15-29-46">
    - No arm: 2022-09-15/ForceMap3-7-c-noarm.pkl
    <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/t-3-7-con-no2-2022-09-15-20-20-16.png" alt="t-3-7-con-no2-2022-09-15-20-20-16">
    <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/t-3-7-3d-con-no-2022-09-15-16-34-52.png" alt="t-3-7-3d-con-no-2022-09-15-16-34-52">

  - ankle 力矩限制 13N
    ```
    # control params
    Coef = [0.6, 0.1, 0.3]
    Pf = [80, 20, 5]
    Vf = [40, 20, 5]    
    Ff = [30, 10, 5]  
    Vff = 99         Pff = 500
    T: 2.0            dt: 0.002
    
    # mass and state pararms
    theta = pi/40
    Ptar = [0, 0, np.pi]
    mass: [15, 20, 6.8]
    inertia: [1.0125, 0.417, 0.09]
    index = 1.3/dt
    F[k] > F[index]*1.04 and k*dt < 1.2
    ```
    -  Free Arm: 2022-09-16/ForceMap3-7-c-arm.pkl
    <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/t3-7-c-arm-2022-09-16-16-51-35.png" alt="t3-7-c-arm-2022-09-16-16-51-35">
    - No arm: 2022-09-16/ForceMap3-7-c-noarm.pkl
    <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/t3-7-c-noarm-2022-09-16-16-51-58.png" alt="t3-7-c-noarm-2022-09-16-16-51-58">
    - Free Arm & No arm 力和平衡时间对比结果：2022-09-17/ForceMap3-7-c-arm.pkl　＆　2022-09-17/ForceMap3-7-c-noarm.pkl
    <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/f-t-cmp-2022-09-17-21-45-33.png" alt="f-t-cmp-2022-09-17-21-45-33">
    - Free Arm & No arm 各部分costfun对比结果：2022-09-17/ForceMap3-7-arm-cfun.pkl　＆　2022-09-17/ForceMap3-7-noarm-cfun.pkl
    <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/costfun-2022-09-17-21-45-48.png" alt="costfun-2022-09-17-21-45-48">

  

###### 现有的结论分析
- **结论**
  - 手臂摆动可以降低关节峰值力矩，但峰值力矩的实际作用意义不大，重要的时平均力矩，同时可以减低15%的身体摆动幅度。
  - 手臂摆动相对于手臂束缚产生的对身体的<font color='red'>惯性力耦合项</font>对waist关节作用过程中起主要作用，帮助降低峰值力矩和足底力。
  - 手臂摆动可以通过<font color='red'>摆动产生的作用于身体的反向加速度降低接近一半足底作用力，延长身体作用时间增加稳定性</font>。
  - 对于不同的ankle力矩限制和初始扰动角度，整体而言，对平均力矩影响不大。
  - 现有的关于足底力和作用时间的结论与文献结论一致
- **存在的问题**
  - 手臂的摆动对关节平均力矩可能影响不大，因此<font color='red'>手臂的影响可能并不在力矩上，而在对身体稳定恢复时间和稳定性的影响上</font>。
- **后面研究计划**
  - 用<font color='red'>传统的稳定性分析方法对稳定恢复的简化模型进行稳定性和稳定域的分析</font>，但可能存在由于该工况不是周期运动的原因难以分析
  - <font color='red'>基于RL的方法研究手臂摆动对全身双足运动的稳定性的影响</font>（用金师兄基于熵稳定性分析的方法）




===============================================================================================================
## 仿真计算的阶段性结论总结
### 研究背景与目的
- 人的手臂除了拥有日常物体的操纵和搬运功能，在一些特定的工况，如在击打投掷、奔跑、跳远、平衡钢索的挑战时，手臂的合理运动可提高运动表现性能，维持身体平衡、甚至减少身体能量消耗。​
- 对于正常步行，手臂正常摆动相比较手臂束缚或者同向摆动，运动所需要消耗的能量更少，角动量更小，稳定性更高，而当身体受到外界扰动时，手臂摆动时的拟合的恢复系数更大，平衡恢复所需要的时间更短，平衡恢复运动的距离更短。
<img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/zq2-2022-09-23-15-58-20.PNG" alt="zq2-2022-09-23-15-58-20">
- 而对当前机器人领域，一方面调研发现，与人体手臂低质量、高运动速度相比，大部分的商业协作机器人质量重，运动速度与人类相差甚远，除了LISM2速度稍有提升，但是仍然难以完成类似于人的高速机动运动。
​<img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/zq4-2022-09-23-16-01-21.PNG" alt="zq4-2022-09-23-16-01-21">
- 另一方面，双足运动研究中，很少有机械臂的运动，然而根据仿真结果，双足机器人在含有双臂摆动的情况下，可以达到的最大速度更高。
<img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/zq7-2022-09-23-16-02-17.jpg" alt="zq7-2022-09-23-16-02-17">
- 我们希望通过对机器人受到外界扰动的稳定恢复过程的分析和奔跑过程的初步探讨研究机械臂摆动对双足运动的作用效果。
  - <font color='red'>扰动后稳定恢复工况</font>
  - <font color='red'>奔跑工况</font>

### 研究方法
#### 生物数据采集
- 采用运动捕获设计采集人体受扰动后平衡恢复的运动数据（MotionCollect/scripts/DynamicsAnalysis.py）。
- 身体质心高度和速度变化对比：
  - 有臂：[450, 800]           （liu_bal4.calc文件和liu1_4.raw文件）
  - 无臂：[10000, 10350]       （liu_bal3.calc文件和liu1_3.raw文件）
  <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/zq11-2022-09-23-16-09-06.PNG" alt="zq11-2022-09-23-16-09-06">
  - 手臂摆动相比较手臂束缚，身体通过更短的时间恢复到平衡位置，导致这种现象的原因可能是在地面提供力和力矩的同时，手臂通过摆动降低了扰动产生的身体的角动量和角速度，从而通过其他关节的作用更快的恢复平衡，因此我们进一步研究了该过程身体各部分角动量的变化过程
- 身体各部分角动量变化对比：
  - 有臂：[2805, 3020]       （参考坐标为左脚， liu_bal2.calc文件和liu1_4.raw文件）
  - 无臂：[9700, 9945]       （参考坐标为左脚， liu_bal3.calc文件和liu1_3.raw文件）
  <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/zq12-2022-09-23-16-12-45.PNG" alt="zq12-2022-09-23-16-12-45">
  - 手臂摆动时可以产生于躯干和腿等量级角动量橙色的曲线，从而相比较手臂束缚而言降低了身体的角动量幅值紫色的曲线。从而使身体更容易恢复到稳定位置。​
- 总结
  - 结论
    - 手臂摆动相比较手臂束缚，身体通过<font color='red'>更短的时间恢复到平衡位置</font>。
    - 手臂摆动相比较手臂束缚，可以<font color='red'>降低身体的角动量幅值</font>紫色的曲线。
  - <font color='red'>不足</font>
    - 运动捕获只能采集位置、方向、速度等运动速度，缺少力矩、地面接触力等力学信息，无法进行完整的动力学分析
    - 运动数据中存在噪音，且会由于运动导致的传感器滑移使得采集的数据存在一定的误差。
  - <font color='red'>解决方法：</font>
    - 建立简化模型，通过数值计算的方法，用轨迹求解计算恢复过程，得到完整的运动和力数据，基于完整数据进行人体运动的运动分析。
#### 稳定恢复的数值计算
- 建模和动力学轨迹优化，采用三连杆和单次的轨迹求解方法
  <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/zq14-2022-09-23-16-18-53.PNG" alt="zq14-2022-09-23-16-18-53">
- 计算身体各部分角动量与生物学数据对比，发现手臂摆动与束缚情况相比，通过手臂摆动产生的角动量可以减小身体角动量的幅值。​手臂摆动相比束缚，可以一定程度减少稳定恢复时间。​
  ```
  # Biped_balance_Map3.py
  # 2022-09-22/Momt_arm.pkl and 2022-09-22/Momt_noarm.pkl
  I = [0.03]
  m = [4.0]
  其他参数与稳定恢复工况数据下惯性参数遍历时，ankle 力矩限制 13N的工况下控制器参数相同
  ```
  <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/zq17-2022-09-23-16-20-00.PNG" alt="zq17-2022-09-23-16-20-00">
- 评价指标定义：为了评价机械臂参数对稳定恢复的影响，<font color='red'>定量的定义了平衡恢复时间</font>，选择<font color='red'>恢复时间、关节力矩、功率、支撑力</font>等作为评价指标。
  <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/zq18-2022-09-23-16-23-45.PNG" alt="zq18-2022-09-23-16-23-45">
- 结果分析：
  - <font color='red'>惯性参数遍历下有臂和无臂结果对比：</font>
    - 机械臂束缚相对比自由摆动，hip关节的关节力矩更大，增加了15%力矩需求
    - 机械臂束缚相对比自由摆动，平衡恢复需要时间更长，平均为自由摆动时的两倍。
    - 机械臂束缚时，所需要的关节力矩的功率是摆动时的2-3倍
    <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/zq19-2022-09-23-16-25-24.PNG" alt="zq19-2022-09-23-16-25-24">
  - <font color='red'>臂摆动时惯性参数的影响</font>
    - 机械臂质量和惯量越大，稳定恢复需要的时间越短（变化浮动在20%左右）
    - 机械臂质量越大，平均支撑力和Hip关节力矩更大（变化浮动在15%左右）
    - 机械臂质量和惯量越大，机械臂shoulder关节力矩越大（最大力矩近似为最小力矩的两倍）
    <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/t-B-arm-2022-09-23-16-27-08.png" alt="t-B-arm-2022-09-23-16-27-08"> 
- <font color='red'>总结</font>
  - 机械臂摆动可能通过<font color='red'>降低躯干的角动量减少平衡恢复时间、降低力矩和功率需求</font>。
  - 机械臂摆动时，<font color='red'>质量和转动惯量越大，平衡恢复时间越短，同时力矩需越大</font>。
  

</br>

- **基于轨迹结果进行多目标优化**
  - 对于求解得到的Fy，torque，bal time关于质量和惯量的关系，对其进行数据拟合，然后综合考虑多个目标求解相对最优值，通过三维拟合得到的二阶多项式的各项系数为
    ```
    ## 拟合多项式： z = c1 + c2*x + c3*y + c4*x*y + c5*x**2 + c6*y**2
    c1 = [326.456, 10.12, -4.089, 0.449, -0.01166, 4.857]       # F
    c2 = [61.225, 1.173, 6.267, -1.455, 0.1, -5.767]            # u_h
    c3 = [0.583, 1.004, 18.9, 0.1045, -0.00287, -19.05]         # u_s
    c4 = [0.737, -0.0677, -0.3886, 0.01737, 0.0044, -0.4758]    # t_b
    ```
    Fy: 原始数据和拟合平面
    <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Fy-2022-10-08-16-26-00.png .png" alt="Fy-2022-10-08-16-26-00.png " style="zoom:50%;" >
    hip torque: 原始数据和拟合平面
    <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/u_h-2022-10-08-16-27-12.png .png" alt="u_h-2022-10-08-16-27-12.png " style="zoom:50%;" >
    shoulder torque: 原始数据和拟合平面
    <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/u_s-2022-10-08-16-27-22.png .png" alt="u_s-2022-10-08-16-27-22.png " style="zoom:50%;" >
    balance time: 原始数据和拟合平面
    <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/t_b-2022-10-08-16-27-34.png .png" alt="t_b-2022-10-08-16-27-34.png " style="zoom:50%;" >

  - 通过拟合方程构建多目标优化问题
    $$
    \begin{aligned}
    &\min_{q}{\sum^n_{i=0}[a_1(\tau_h/\tau_{hmax})^2+a_2(\tau_s/\tau_{smax})^2+a_3(F_y/F_{ymax})^2+a_4(t_{bal}/t_{bmax})^2]}\\
    &\quad\quad s.t.\quad
    
    \begin{aligned}
    &\left\{
    	  \begin{aligned}
          &c_{10} + c_{11}*q_0+c_{12}*q_1+c_{13}*q_0q_1+c_{14}*q_0^2+c_{15}*q_1^2=F_y \\
          &c_{20} + c_{21}*q_0+c_{22}*q_1+c_{23}*q_0q_1+c_{24}*q_0^2+c_{25}*q_1^2=u_h \\
          &c_{30} + c_{31}*q_0+c_{32}*q_1+c_{33}*q_0q_1+c_{34}*q_0^2+c_{35}*q_1^2=u_s \\
          &c_{40} + c_{41}*q_0+c_{42}*q_1+c_{43}*q_0q_1+c_{44}*q_0^2+c_{45}*q_1^2=t_{bal} \\
        \end{aligned}
    \right.&{Contraints}\\
    &\left\{
    	  \begin{aligned}
          &\underline{q}\le q \le \bar{q} \\
          &\underline{u}\le u \le \bar{u} \\
          &\underline{F}_y\le F_y \le \bar{F}_y \\
          &\underline{t}_{bal}\le t_{bal} \le \bar{t}_{bal} \\
      	\end{aligned}
    \right.&{Boundary}\\
    \end{aligned}
    \end{aligned}
    $$

  - **<font color='red'>多目标优化结果</font>**
    ```
    Mass:               4.067 kg
    Inertia:            0.099 kg.m2
    
    a_coeff = [0.2, 0.2, 0.2, 0.4] # objective coef
    #======================================
    hip torque:         67.63 N.m
    shoulder torque:    6.36  N.m
    Fy:                 367.25 N
    balance time:       0.498 s
    ```

#### 奔跑工况的数值计算
- 建模和动力学轨迹优化
  <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/zq22-2022-09-23-16-30-54.PNG" alt="zq22-2022-09-23-16-30-54">
- 不同速度下，有臂无臂的结果对比（2022-09-23/Vel-Force-arm.pkl和2022-09-23/Vel-Force-noarm2.pkl文件）
  ```
  # Biped_walk_VelFMap.py
  Period = [0.53, 0.46, 0.445, 0.38, 0.38, 0.35, 0.35, 0.33]
  Stance = [0.45, 0.41, 0.32, 0.30, 0.30, 0.25, 0.24, 0.26]
  Vt = [2.0, 3.0, 4.0, 5.0, 6.0, 8.0, 9.0, 10.0]
  ```
  - 高速下，摆臂可以降低关节的峰值力矩和支撑力最大值。
  - 速度越大，对力矩、支撑力的需求也越大
  - 手臂的摆臂与否与奔跑工况影响不大。
  <img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Vel-F-cmp-2022-09-23-16-36-01.png" alt="Vel-F-cmp-2022-09-23-16-36-01">

### 研究计划
- 对稳定恢复工况得到的惯性参数结果，再进行一层的优化，得到一组优化的机械臂参数
- 设计机械臂，搭建硬件平台进行实验验证
- 基于RL控制器对双足运动时的有臂和无臂基于金师兄的熵和庞卡莱界面的判剧分析起稳定性和能量消耗结果。

<font color='DeepSkyBlue' size='6'>O(∩_∩)O哈哈~，手臂的作用和优化结果出来了，老子中期答辩没问题了，再优化一步，机械臂硬件，老子来了！！！</font>


===============================================================================================================
## 机械臂高机动动态性能评价指标设计
### 机械臂运动工况分类
- 人体各项体育运动参数

| 类型 | 质量 | 冲击力 | 接触时间 | 速度 | 最高速度 | 运动时间 |
| ---- | -------- | ---------------- | ------------ | ------------- | ------------- |------------- |
| 乒乓球 | 0.0027 kg | 2.94 N | 1.4 ms | 20 m/s | 47.2 m/s | 150 ms |
| 羽毛球 | 0.005 kg |  | 4 ms | 56 m/s | 118 m/s | 80 ms  |
| 高尔夫 | 0.045 kg | 10kN | 0.42 ms | 60 m/s | 91 m/s | 250 ms | 
| 网球 | 0.057 kg | 1200 N | 5.2 ms | 60 m/s | 70 m/s | 140 ms |
| 棒球 | 0.145 kg | 20 kN | 0.8 ms | 60m/s | 47 m/s | 200 ms |
| 排球 | 0.27 kg | 402 N | 12.7 ms | 60m/s | 38 m/s | 260 ms |
| 足球 | 0.4 kg | 1100 N | 9.3 ms | 60m/s | 61 m/s |  150 ms |
| 拳击 | 60 kg |  | 20 ms |  |  |  230 ms |

- 机械臂运动工况分类
  从运动时间图中可以看到大部分动态工况的运动时间在50-300ms之间，因此可以选择200ms作为动态运动的特征时间。
<div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/ct-mass-2022-12-05-19-45-10.png .png" alt="ct-mass-2022-12-05-19-45-10.png " > </div>

<div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/swingtime2-2022-12-12-19-02-39.png .png" alt="swingtime2-2022-12-12-19-02-39.png " > </div>

### 基于生物学速度-质量机理提出冲量的性能指标
#### 单杆冲量建模及分析
- 生物学速度-质量机理
理论上生物的质量越大，其速度愉快，然而由于实际的能量限制，质量过大的生物难以加速到理论的最快速度

$$
\begin{aligned}
v_m &= aM^b\\
v(t)&=v_m(1-e^{-kt})\\
\end{aligned}
$$
其中k类似于加速度的概念，而生物的肌肉力量由于其重量有关，因此得到其加速度与质量的关系
$$
\begin{aligned}
\left\{
    \begin{aligned}
    k\sim \frac{F}{M} \\
    F\sim M^d
    \end{aligned}
\right. \qquad
\Rightarrow \qquad
k=cM^{d-1}
\end{aligned}
$$
特征时间：生物提粗春的能量限制了其可以加速的特征时间，而能储存的能量由于其肌肉（重量）相关，因此
$$
t = fM^g
$$
于是便可以得到生物实际的最快速度与其质量的关系
$$
v(t)=aM^b(1-e^{-cfM^{d-1+g}})
$$
<div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/v-m-2022-12-07-14-44-05.png .png" alt="v-m-2022-12-07-14-44-05.png " > </div>
<div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/v-m2-2022-12-07-14-44-22.png .png" alt="v-m2-2022-12-07-14-44-22.png " > </div>

- **机械臂冲量动态指标**
对于高机动机械臂而言，其性能指标难以简单的用力矩和速度表示，而是与外界交互时刻的冲量更加重要，类似于拳击中的拳力的概念，因此提出冲量的概念用于描述机械臂的其特征时间内可以达到的动态性能
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/impact_onelink.drawio-2022-12-09-13-59-46.png .png" alt="impact_onelink.drawio-2022-12-09-13-59-46.png " > </div>

$$
\Lambda = M_c\Delta \dot{x}
$$
而由于日常生活而言，尽管理论上对于任意的机械臂其都可以加速到最快速度，然而由于任务时间（路径）的限制，无法在有限的时间（路径）内达到最快速度以至于获得最大的冲量。而其特征时间内可以达到最快速度与其末端质量和减速比有关，以最简单的单根杆运动为例，因此对于速度而言，也有与上述类似的关系

$$
\dot q = \dot q_m(1-e^{-kt})
$$
其中特征时间t同样与质量有关，如果负载不变，电机确定，可以认为是减速比$\gamma$的函数
$$
t=f\gamma^g
$$
k类似于加速度的概念，
$$
\begin{aligned}
k\sim \frac{\gamma \tau_m}{\gamma^2I_m+I_{link}} \qquad
\Rightarrow \qquad
k=c\frac{\gamma \tau_m}{\gamma^2I_m+I_{link}}
\end{aligned}
$$
因此冲量可以表示为
$$
\Lambda = M_c\Delta \dot{x}=\dot q_m (\gamma^2I_m+I_{link})(1-e^{-\frac{cf\tau_m \gamma^{g+1}}{\gamma^2I_m+I_{link}}})
$$
假设一些参数并带入，得到一组测试结果
```
c = 0.02
f = 0.04
g = 0.8
I_m = 5e-4
I_l = 2.0*0.6**2/12
tm = 10
qm = 100*np.pi
```
<div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/impact-y-2022-12-09-14-17-56.png .png" alt="impact-y-2022-12-09-14-17-56.png " > </div>

- **连杆惯量——冲量关系**
同样的方法，当把连杆质量作为目标量时，上述中将特征时间的方程修改为
$$
t=fI_{link}^g
$$
M𝑡for compact representatio便可以得到新的冲量表达式
$$
\Lambda = M_c\Delta \dot{x}=\dot q_m (\gamma^2I_m+I_{link})(1-e^{-\frac{cf\gamma \tau_m I^g_{link} }{\gamma^2I_m+I_{link}}}) 
$$
```
c = 0.02
f = 0.04
g = 0.8
I_m = 5e-4
gamma = 5
tm = 10
qm = 100*np.pi
```
<div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/inertia_impact-2022-12-09-14-17-39.png .png" alt="inertia_impact-2022-12-09-14-17-39.png " > </div>

- 问题
  该方法不太合理，一方面角速度的函数关系建立没有逻辑，另一方面涉及到的各个系数的选取没有道理也难以实际获得，拍脑袋的参数确定使得结果没有意义，因此需要从动力学本身结果电机限制推导电机的速度方程

### 基于动力学和电机曲线的冲量方程推导

#### 单杆冲量建模和分析

<div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/impact_onelink.drawio-2022-12-09-13-59-46.png .png" alt="impact_onelink.drawio-2022-12-09-13-59-46.png " > </div>

对于理想电机和单杆工况而言，力矩和角加速度的动力学方程关系有
$$
\tau = I_0\ddot q, \qquad I_0=\gamma^2I_m+I_l
$$

其中对于力矩而言，简单模型电机力矩与转速有函数限制
$$
\begin{aligned}
\tau&=\gamma \tau_m=\gamma*k_t\frac{U_0-k_v \dot q_m}{R} \\
\dot q_m&=\gamma \dot q
\end{aligned}
$$

因此带入上述的动力学方程可以得到二阶常系数非线性微分方程
$$
\begin{aligned}
\left \{
    \begin{aligned}
    c&=a\ddot q + b\dot q \\
    a &= \gamma^2I_m+I_l\\
    b&=\frac{\gamma^2k_tk_v}{R}\\
    c&=\frac{\gamma k_tU_0}{R}
    \end{aligned}
\right.
\end{aligned}
$$

求解该微分方程可以得到角速度的关系
$$
\dot q = \frac{U_0}{k_v\gamma}(1-e^{-\frac{\gamma^2k_tk_v}{R(\gamma^2I_m+I_l)}t})
$$

对于大多数动态运动的时间大约在0.2s左右，因此可以去特征时间t=0.2s，则其冲量可以表示为
$$
\Lambda = M_c \Delta q = (\gamma^2I_m+I_l)*\frac{U_0}{k_v\gamma}(1-e^{-\frac{\gamma^2k_tk_v}{R(\gamma^2I_m+I_l)}t})
$$
测试结果
```
U0 = 24.0
R = 0.127
Kv = 0.6
Kt = 0.075
I_m = 5e-4
t = 0.1
tm=10

I_l = 3.0*0.7**2/3
gamma = np.linspace(1,20,50)
kd = 0.1
```
<div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/impact-gamma-2022-12-10-20-35-06.png .png" alt="impact-gamma-2022-12-10-20-35-06.png " > </div>

- 结果分析
  对于机械臂的动态运动工况，与外界物体的交互过程中主要是动量的交换，不管是小质量物体的速度要素还是大质量物体接触时的冲击力要素，归根到底时动量交换的结果（不同工况的特征作用时间和冲量需求图），因此为了描述机械臂动态需求，不同于传统基于雅克比矩阵，本文选择冲量为评价指标，并基于简单模型的给出了冲量关于电机参数（惯量、减速比、系数）和负载参数（惯量等）的显式解析公式，可以用于优化电机参数和负载参数，同时考虑到大部分运动交互时间在0.1-0.3s作用，因此为例验证不同参数的动态性能，我们选取统一的特征时间下（t=0.2s）其冲量的结果。
  $$
  \Lambda = M_c \Delta q = (\gamma^2I_m+I_l)*\frac{U_0}{k_v\gamma}(1-e^{-\frac{\gamma^2k_tk_v}{R(\gamma^2I_m+I_l)}t})
  $$


#### 二连杆冲量建模及分析（最大功率）
- **两个关节的减速比相同**
  - 对于二连杆动力学方程如果只考虑水平面内的运动,即不考虑重力
  $$
  \begin{bmatrix}
  M_{11} &M_{12}\\
  M_{21} &M_{22}\\
  \end{bmatrix}
  \begin{bmatrix}
  \ddot q_1\\
  \ddot q_2\\
  \end{bmatrix} + 
  \begin{bmatrix}
  C_{1}\\
  C_{2}\\
  \end{bmatrix}  =
  \begin{bmatrix}
  \tau_{1}\\
  \tau_{2}\\
  \end{bmatrix}
  $$
    其中将电机模型带入力矩可以得到
  $$
  M(q)\ddot q+C(q,\dot q) = \frac{\gamma k_tU_0}{R} - \frac{\gamma^2k_tk_v}{R}\dot q
  $$
  - 将方程转化为一阶常微分方程标准形式方便计算,通过scipy中的odeint求解器可以得到其数值解用于计算冲量
    $$
    \begin{aligned}
    \left \{
      \begin{aligned}
      y_{11} = q_1\\
      y_{12} = \dot q_1\\
      y_{21} = q_2\\
      y_{22} = \dot q_2\\
      \end{aligned}
      \right.
      \qquad \Rightarrow \qquad
      \left \{
      \begin{aligned}
      \dot y_{11} &= y_{12}\\
      \dot y_{12} &= M^{-1}_{11}(c-b y_{12}-Cq_1) +M^{-1}_{12}(c-b y_{22}-Cq_2) \\
      \dot y_{21} &= y_{22}\\
      \dot y_{22} &= M^{-1}_{21}(c-b y_{12}-Cq_1) +M^{-1}_{22}(c-b y_{22}-Cq_2)\\
      \end{aligned}
      \right.
    \end{aligned} 
    $$

  - 通过计算最后时刻的冲量,然后遍历各个减速比下的冲量便可以得到
    ```python
    # 2022.12.19
    # 几何参数
    l1 = 0.4
    l2 = 0.4
    m1 = 2.0
    m2 = 2.0
    
    # 电机参数
    U0 = 24.0
    R = 0.127
    Kv = 0.6
    Kt = 0.075
    Im = 5e-4
    
    # 特征时间和减速比参数
    ts = 0.12
    Nsample = 200
    t = np.linspace(0, ts, Nsample)
    gamma = np.linspace(1,20,50)
    ```
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/t_0.12-2022-12-19-16-50-20.png .png" alt="t_0.12-2022-12-19-16-50-20.png " > </div>
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/t_0.12-y_4-2023-02-09-10-14-23.gif .gif" alt="t_0.12-y_4-2023-02-09-10-14-23.gif " > </div>

- **两个关节的减速比不同（收缩轨迹）**
  - 对于二连杆动力学方程如果只考虑水平面内的运动,即不考虑重力，且为伸展轨迹
  $$
  \begin{bmatrix}
  M_{11} &M_{12}\\
  M_{21} &M_{22}\\
  \end{bmatrix}
  \begin{bmatrix}
  \ddot q_1\\
  \ddot q_2\\
  \end{bmatrix} + 
  \begin{bmatrix}
  C_{1}\\
  C_{2}\\
  \end{bmatrix}  =
  \begin{bmatrix}
  \tau_{1}\\
  \tau_{2}\\
  \end{bmatrix}
  $$
  其中质量矩阵可以表示为
   $$
     \left\{
     \begin{aligned}
     M_{11} &= m_2l_1^2+\frac{1}{3}m_1l_1^2+\frac{1}{3}m_2l_2^2+m_2l_1l_2C_2 + \gamma_1^2I_m\\
     &=m_1l_{c1}^2+m_2(l_1^2+l_{c2}^2+2l_1l_{c2}C_2)+I_1+I_2 + \gamma_1^2I_m\\
     M_{12}&=\frac{1}{3}m_2l_2^2+\frac{1}{2}m_2l_1l_2C_2 \\
     &=m_2(l_{c2}^2+l_1l_{c2}C_2)+I_2\\
     &=M_{21}\\
     M_{22}&=\frac{1}{3}m_2l_2^2 + \gamma_2^2I_m\\
     &=m_2l_{c2}^2+I_2 + \gamma_2^2I_m\\
     \end{aligned}
     \right.
     $$
  将最大功率的电机模型带入力矩可以得到
  $$
  M(q)\ddot q+C(q,\dot q) = 
  \frac{k_tU_0}{R}
  \begin{bmatrix}
  \gamma_{1}\\
  \gamma_{2}\\
  \end{bmatrix} -
  \frac{k_tk_v}{R}
  \begin{bmatrix}
  \gamma_{1}^2\\
  \gamma_{2}^2\\
  \end{bmatrix}\dot q
  $$
  - 将方程转化为一阶常微分方程标准形式方便计算,通过scipy中的odeint求解器可以得到其数值解用于计算冲量
    $$
    \begin{aligned}
    \left \{
      \begin{aligned}
      y_{11} = q_1\\
      y_{12} = \dot q_1\\
      y_{21} = q_2\\
      y_{22} = \dot q_2\\
      \end{aligned}
      \right.
      \qquad \Rightarrow \qquad
      \left \{
      \begin{aligned}
      \dot y_{11} &= y_{12}\\
      \dot y_{12} &= M^{-1}_{11}(c_{f1}-b_{f1} y_{12}-Cq_1) +M^{-1}_{12}(c_{f2}-b_{f2} y_{22}-Cq_2) \\
      \dot y_{21} &= y_{22}\\
      \dot y_{22} &= M^{-1}_{21}(c_{f1}-b_{f1} y_{12}-Cq_1) +M^{-1}_{22}(c_{f2}-b_{f2} y_{22}-Cq_2)\\
      \end{aligned}
      \right.
    \end{aligned} 
    $$

  - 通过计算最后时刻的冲量,然后遍历各个减速比下的冲量便可以得到
    ```python
    # 2023.02.09
    # 几何参数
    l1 = 0.4
    l2 = 0.4
    m1 = 2.0
    m2 = 2.0
    
    # 电机参数
    U0 = 24.0
    R = 0.127
    Kv = 0.6
    Kt = 0.075
    Im = 5e-4
    
    # 特征时间和减速比参数
    ts = [0.12, 0.15, 0.2]
    Nsample = 200
    t = np.linspace(0, ts, Nsample)
    gamma = np.linspace(1,20,20)
    gamma2 = np.linspace(1,20,20)
    ```
    - 特征时间t=0.2s
      <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/GamMap_2-2-2023-02-09-15-44-11.png .png" alt="GamMap_2-2-2023-02-09-15-44-11.png " > </div>
      减速比分别为5和2时的运动轨迹
      <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/t_0.2-pm_5_2-2023-02-09-16-05-10.gif .gif" alt="t_0.2-pm_5_2-2023-02-09-16-05-10.gif " > </div>
      减速比分别为1和2时的坏点的运动轨迹
      <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/t_2-pm_12-2023-02-09-15-45-13.gif .gif" alt="t_2-pm_12-2023-02-09-15-45-13.gif " > </div>
      其中两个关节在运动过程中不同减速比下的最大角度分布图为
      q1:
      <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/dq1_2-2023-02-09-15-46-19.png .png" alt="dq1_2-2023-02-09-15-46-19.png " > </div>
      q2: 可以选 pi/2 < q1 < 2pi/3 和 0 < q1 < 2pi/3 作为关节范围限制,选出不合理的减速比组合范围
      <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/dq2_2-2-2023-02-09-15-56-25.png .png" alt="dq2_2-2-2023-02-09-15-56-25.png " > </div>
    
    - 特征时间t=0.15s(动画为两个减速比分别为1和2时的坏点的运动轨迹)
      <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/GamMap_15-2023-02-09-15-47-19.png .png" alt="GamMap_15-2023-02-09-15-47-19.png " > </div>

      其中两个关节在运动过程中不同减速比下的最大角度分布图为
      q1:
      <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/dq1_15-2023-02-09-15-48-03.png .png" alt="dq1_15-2023-02-09-15-48-03.png " > </div>
      q2:
      <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/dq2_15-2023-02-09-15-48-17.png .png" alt="dq2_15-2023-02-09-15-48-17.png " > </div>

    - 特征时间t=0.12s(动画为两个减速比分别为1和2时的坏点的运动轨迹)
      <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/GamMap_12-2023-02-09-15-48-31.png .png" alt="GamMap_12-2023-02-09-15-48-31.png " > </div>
      <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/t_12-pm_12-2023-02-09-15-48-44.gif .gif" alt="t_12-pm_12-2023-02-09-15-48-44.gif " > </div>
      其中两个关节在运动过程中不同减速比下的最大角度分布图为
      q1:
      <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/dq1_12-2023-02-09-15-51-30.png .png" alt="dq1_12-2023-02-09-15-51-30.png " > </div>
      q2:
      <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/dq2_12-2023-02-09-15-51-57.png .png" alt="dq2_12-2023-02-09-15-51-57.png " > </div>

- **两个关节的减速比不同（伸展轨迹）**
  - 与伸展轨迹相比，对于理论方程只需要将上式修改为
    将最大功率的电机模型带入力矩可以得到
    $$
    M(q)\ddot q+C(q,\dot q) = 
    -\frac{k_tU_0}{R}
    \begin{bmatrix}
    \gamma_{1}\\
    \gamma_{2}\\
    \end{bmatrix} -
    \frac{k_tk_v}{R}
    \begin{bmatrix}
    \gamma_{1}^2\\
    \gamma_{2}^2\\
    \end{bmatrix}\dot q
    $$
    - 通过计算最后时刻的冲量,然后遍历各个减速比下的冲量便可以得到
    ```python
    # 2023.02.26
    # 几何参数
    l1 = 0.4
    l2 = 0.4
    m1 = 2.0
    m2 = 2.0
    
    # 电机参数
    U0 = 24.0
    R = 0.127
    Kv = 0.6
    Kt = 0.075
    Im = 5e-4
    
    # 特征时间和减速比参数
    ts = [0.2]
    Nsample = 200
    t = np.linspace(0, ts, Nsample)
    gamma = np.linspace(1,20,20)
    gamma2 = np.linspace(1,20,20)
    ```
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/t_0.2-pm_3-3_0.67-2023-02-28-21-28-52.gif .gif" alt="t_0.2-pm_3-3_0.67-2023-02-28-21-28-52.gif " > </div>
    q2角度分布变化（小于0度均为不可解）
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/q2m_0.67q2-2023-02-28-21-29-18.png .png" alt="q2m_0.67q2-2023-02-28-21-29-18.png " > </div>
    冲量Lamda分布
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Lam_0.67q2-2023-02-28-21-29-18.png .png" alt="Lam_0.67q2-2023-02-28-21-29-18.png " > </div>

  - 问题：
    力矩的选择不合理，为什么两个关节都要以最大功率运动，对于单连杆而言，由于其末端速度与角速度直接相关，因此最大功率合理，然而对于二连杆而言，其对于固定轨迹追求末端速度最大则由于末端速度是两个关节速度的组合，那就不一定要求两个关节都已最大功率运行。

  - 解决方法：
    - 轨迹优化
    基于之前的轨迹优化的方法，给定参考轨迹后计算其末端的冲量，但是问题是以冲量为目标函数涉及到$(JM^{-1}J^T)^{-1}$逆矩阵的表示，而casadi计算库中我还未发现矩阵逆的求解方法？？？(不太可行，数值计算尽量不要涉及求逆运算，而且如果把该问题交给优化，就忽略了其动力学本体，与第一阶段的单摆模型脱节)
    - 操作空间而非关节空间考虑
    $\Delta \dot x$如何绕开关节表示本身就是个问题（方法：可以考虑给定末端轨迹同时第一关节最大功率工作）

#### 给定轨迹的二连杆冲量建模及分析
- 对于二连杆动力学方程如果只考虑水平面内的运动,即不考虑重力，但是由于之前两个关节均以最大功率运行的不合理假设，因此该部分选择将问题从关节空间转移到操作空间，即
  - 假设给定机械臂末端轨迹，这样两个关节有了约束关系
  - 假设第一个关节电机以最大功率运行
  这样将两个关节见的几何关系（位置和速度公式）带入动力学方程便可以从第一个方程得到q1的运动轨迹，继而有了q2的运动轨迹和功率需求
    $$
    \begin{bmatrix}
    M_{11} &M_{12}\\
    M_{21} &M_{22}\\
    \end{bmatrix}
    \begin{bmatrix}
    \ddot q_1\\
    \ddot q_2\\
    \end{bmatrix} + 
    \begin{bmatrix}
    C_{1}\\
    C_{2}\\
    \end{bmatrix}  =
    \begin{bmatrix}
    \tau_{1}\\
    \tau_{2}\\
    \end{bmatrix}
    $$
    其中将电机模型带入力矩可以得到
    $$
    M(q)\ddot q+C(q,\dot q) = \frac{\gamma k_tU_0}{R} - \frac{\gamma^2k_tk_v}{R}\dot q
    $$

- 给定末端直线轨迹
  - 二连杆关节间的运动约束有
    $$
    \begin{aligned}
    \left \{
      \begin{aligned}
      y_{11} &= q_1 \qquad q2 = \pi - 2*q_1\\
      y_{12} &= \dot q_1  \qquad \dot q_2 = - 2*\dot q_1\\
      y_{21} &= q_2=\pi - 2*y_{11}\\
      y_{22} &= \dot q_2 = - 2*y_{12}\\
      \end{aligned}
      \right.
    \end{aligned}
    $$
  - 将方程转化为一阶常微分方程标准形式方便计算,通过scipy中的odeint求解器可以得到其数值解用于计算冲量
    $$
    \begin{aligned}
    \left \{
      \begin{aligned}
      y_{11} = q_1\\
      y_{12} = \dot q_1\\
      y_{21} = q_2\\
      y_{22} = \dot q_2\\
      \end{aligned}
      \right.
      \qquad \Rightarrow \qquad
      \left \{
      \begin{aligned}
      \dot y_{11} &= y_{12}\\
      \dot y_{12} &= M^{-1}_{11}(c-b y_{12}-Cq_1) +M^{-1}_{12}(c-b y_{22}-Cq_2) \\
      \dot y_{21} &= y_{22}\\
      \dot y_{22} &= M^{-1}_{21}(c-b y_{12}-Cq_1) +M^{-1}_{22}(c-b y_{22}-Cq_2)\\
      \end{aligned}
      \right.
    \end{aligned} 
    $$

  - 只需要计算前两个微分方程组，则通过计算最后时刻的冲量,然后遍历各个减速比下的冲量便可以得到
    ```python
    ## 2023.02.01
    # 几何参数
    l1 = 0.4
    l2 = 0.4
    m1 = 2.0
    m2 = 2.0
    
    # 电机参数
    U0 = 24.0
    R = 0.127
    Kv = 0.6
    Kt = 0.075
    Im = 5e-4
    
    # 特征时间和减速比参数
    ts = 0.12
    Nsample = 200
    t = np.linspace(0, ts, Nsample)
    gamma = np.linspace(1,20,50)
    ```
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/t_0.12_l-2023-02-01-15-20-24.png .png" alt="t_0.12_l-2023-02-01-15-20-24.png " > </div>

    ```python
    ## 2023.02.01
    # 特征时间和减速比参数
    ts = 0.08
    Nsample = 200
    t = np.linspace(0, ts, Nsample)
    gamma = np.linspace(1,20,50)
    ```
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/t_0.08_l-2023-02-01-15-27-00.png .png" alt="t_0.08_l-2023-02-01-15-27-00.png " > </div>


- 给定末端圆形轨迹
  - 二连杆关节间的圆弧运动约束有，其中q2为常数
    $$
    \begin{aligned}
    \left \{
      \begin{aligned}
      y_{11} &= q_1\\
      y_{12} &= \dot q_1\\
      y_{21} &= q_2\\
      y_{22} &= 0.0\\
      \end{aligned}
      \right.
    \end{aligned}
    $$
  - 将方程转化为一阶常微分方程标准形式方便计算,通过scipy中的odeint求解器可以得到其数值解用于计算冲量
    $$
    \begin{aligned}
    \left \{
      \begin{aligned}
      y_{11} = q_1\\
      y_{12} = \dot q_1\\
      y_{21} = q_2\\
      y_{22} = \dot q_2\\
      \end{aligned}
      \right.
      \qquad \Rightarrow \qquad
      \left \{
      \begin{aligned}
      \dot y_{11} &= y_{12}\\
      \dot y_{12} &= M^{-1}_{11}(c-b y_{12}-Cq_1) +M^{-1}_{12}(c-b y_{22}-Cq_2) \\
      \dot y_{21} &= y_{22}\\
      \dot y_{22} &= M^{-1}_{21}(c-b y_{12}-Cq_1) +M^{-1}_{22}(c-b y_{22}-Cq_2)\\
      \end{aligned}
      \right.
    \end{aligned} 
    $$

  - 只需要计算前两个微分方程组，则通过计算最后时刻的冲量,然后遍历各个减速比下的冲量便可以得到
    ```python
    ## 2023.02.01
    # 几何参数
    l1 = 0.4
    l2 = 0.4
    m1 = 2.0
    m2 = 2.0
    
    # 电机参数
    U0 = 24.0
    R = 0.127
    Kv = 0.6
    Kt = 0.075
    Im = 5e-4
    
    # 特征时间和减速比参数
    ts = 0.12
    q2 = np.pi/4
    Nsample = 200
    t = np.linspace(0, ts, Nsample)
    gamma = np.linspace(1,20,50)
    ```
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/t_0.12_c_45-2023-02-01-15-23-24.png .png" alt="t_0.12_c_45-2023-02-01-15-23-24.png " > </div>

#### 轨迹优化中给定轨迹下冲量分析

- 椭圆轨迹(遍历gamma)

    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/ell3_fit-2023-02-08-12-29-57.png .png" alt="ell3_fit-2023-02-08-12-29-57.png " > </div>

- 椭圆轨迹收缩(将gamma也作为优化变量)
    ```python
    ## 2023.02.28/shenzhan_gam3.24-3.42
    # 几何参数
    l1 = 0.4
    l2 = 0.4
    m1 = 2.0
    m2 = 2.0
    
    # 电机参数
    U0 = 24.0
    R = 0.127
    Kv = 0.6
    Kt = 0.075
    Im = 5e-4
    
    # 特征时间和约束条件
    ts = 0.2
    self.q_LB = [-np.pi/2, 0] 
    self.q_UB = [2*np.pi/3, 2*np.pi/3] 
    init(walker.gam[0], 5.0)
    init(walker.gam[1], 2.6)
    init(walker.q[i][0], np.pi/6) # 初始值
    ceq.extend([x_end**2/0.48+y_end**2/0.27 - 1==0]) # 椭圆轨迹限制

    ## 结果
    Lambda = 12.2
    gamma = [3.24, 3.42]
    ```

    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/2023-02-28-21-02-18traj_ani-2023-02-28-21-07-31.gif .gif" alt="2023-02-28-21-02-18traj_ani-2023-02-28-21-07-31.gif " > </div>
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Lambda_e-2023-02-28-21-13-56.jpg .jpg" alt="Lambda_e-2023-02-28-21-13-56.jpg " > </div>


- 椭圆轨迹伸展(将gamma也作为优化变量)
    ```python
    ## 2023.02.28/GAM5.13-3.47
    # 几何参数
    l1 = 0.4
    l2 = 0.4
    m1 = 2.0
    m2 = 2.0
    
    # 电机参数
    U0 = 24.0
    R = 0.127
    Kv = 0.6
    Kt = 0.075
    Im = 5e-4
    
    # 特征时间和约束条件
    ts = 0.2
    self.q_LB = [-np.pi/2, 0] 
    self.q_UB = [2*np.pi/3, 2*np.pi/3] 
    init(walker.gam[0], 5.0)
    init(walker.gam[1], 4.3)    # 5.13-3.47
    init(walker.q[i][0], np.pi*0.4) # 初始值
    x_eff = 0.64
    y_eff = 0.78
    ceq.extend([x_end**2/(x_eff**2)+y_end**2/(y_eff**2) - 1==0]) # 椭圆轨迹限制

    ## 结果
    Lambda = 16
    gamma = [5.13, 3.47]
    ```

    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/2023-02-28-20-58-46traj_ani-2023-02-28-21-16-47.gif .gif" alt="2023-02-28-20-58-46traj_ani-2023-02-28-21-16-47.gif " > </div>
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Lambda_e-2023-02-28-21-17-30.jpg .jpg" alt="Lambda_e-2023-02-28-21-17-30.jpg " > </div>

- 结果：
  - 通过理论计算和相同目标函数下轨迹优化的结果对比发现，一方面，初始的机械臂状态对优化结果有很大影响，也就是说针对于不同的工况需求机械臂的要求也不同，难以得到所谓的统一的机械臂参数。另一方面，减速比初始参考值对优化结果有较大的影响，只能通过调参根据结果选择合适的初始参数。

- 问题：
  - 轨迹优化得到的解是通过功率和速度目标函数得到的而非直接通过冲量为直接目标，因此与冲量最大直接关系有待商讨
  - 既然轨迹优化可以得到较优的减速比组合，那么之前理论分析的意义是什么？
    - 理论分析基于的是最简化的理论模型，可以为之后的动力学仿真提供一个大致的合理的参数范围，缩小后续的优化空间
  - 不同轨迹对和初始角度的是否有很大的影响？
    - 测试结果：
  - 不同的gamma初始值有很大影响？
    - 不同的gamma初始值会将解汇聚在[2.5, 3.8],[7.5, 8.9]几个组合范围中，而其中[2.5, 4.2]左右的运动轨迹还较为合理，其他的轨迹过于短，而且冲量小


## 第一篇文章
### 大纲
- 生物学中手臂对身体平衡的研究分析
- 现有机器人手臂作用研究现状
- 我们认为平衡恢复中动量起到重要作用
- 基于动量最大指标和功率最大假设优化机械臂得到机械臂参数
- 上组优化参数的机械臂对稳定恢复的影响的对比（力矩稳定恢复时间）
- 关于多参数协同优化下的机械臂性能与基于动量的方法的结果对比

### 需要补的仿真和实验
- 完成基于动量方法中轨迹优化和理论计算的验证
- 基于动量的方法将m,L,gam多参数协同优化，并分析结果
- 基于稳定恢复对m,L,gam多参数协同优化并分析结果
- 对比有无机械臂的结果，对比两种方法得到的机械臂结果
- 硬件实验验证

#### 工作框架
  <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/设计流程2-2023-03-08-14-06-07.png .png" alt="设计流程2-2023-03-08-14-06-07.png " > </div>

#### 冲量模型与轨迹优化的结果验证
- 由于基于冲量模型的计算结果与其初始位置有关，因此为了验证冲量模型参数优化的合理性，基于同样的工况，给定一定的轨迹去优化机械臂减速比与冲量模型的结果相互验证。
  <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/impact_twolink-2023-03-08-14-10-54.png .png" alt="impact_twolink-2023-03-08-14-10-54.png " > </div>

##### 收缩轨迹验证
- 冲量模型的动力学方程可表示为
    $$
    M(q)\ddot q+C(q,\dot q) = 
    \frac{k_tU_0}{R}
    \begin{bmatrix}
    \gamma_{1}\\
    \gamma_{2}\\
    \end{bmatrix} -
    \frac{k_tk_v}{R}
    \begin{bmatrix}
    \gamma_{1}^2\\
    \gamma_{2}^2\\
    \end{bmatrix}\dot q
    $$
    $$
    \Lambda = M_c\Delta{\dot q}=(JM^{-1}J^T)^{-1}\Delta{\dot q}
    $$
    取特征时间t=0.2s，可以得到不同参数下冲量的分布图
    ```python
    # 2023.02.09
    # 几何参数
    l1 = 0.4
    l2 = 0.4
    m1 = 2.0
    m2 = 2.0

    # 电机参数
    U0 = 24.0
    R = 0.127
    Kv = 0.6
    Kt = 0.075
    Im = 5e-4

    # 特征时间和减速比参数
    ts = [0.12, 0.15, 0.2]
    Nsample = 200
    t = np.linspace(0, ts, Nsample)
    gamma = np.linspace(1,20,20)
    gamma2 = np.linspace(1,20,20)

    ## 优化结果
    # 通过设定关节2最大角度不超过2*np.pi/3来找出可行域
    gam1 = 3-6
    gam2 = 2-4
    ```
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/GamMap_2-2-2023-03-08-10-42-03.png .png" alt="GamMap_2-2-2023-03-08-10-42-03.png " > </div>
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/dq2_2-3-2023-03-08-10-42-03.png .png" alt="dq2_2-3-2023-03-08-10-42-03.png " > </div>
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/t_0.2-pm_33-2023-03-08-10-44-12.gif .gif" alt="t_0.2-pm_33-2023-03-08-10-44-12.gif " > </div>
- 轨迹优化方法和结果
  - 轨迹求解的优化方程和约束
    $$
    \begin{aligned}
    &\min_{q_i,\dot{q}_i,\tau_i,F_i}{\sum^n_{i=0}(\tau_{1i} \dot q_{1i}+\tau_{2i} \dot q_{2i})^2}\\
    &\quad\quad s.t.\quad
    \begin{aligned}
        &\color{Crimson}{\left\{
            \begin{aligned}
                &q_{i+1}-q_i-\frac{dt}{2}(\dot{q}_{i+1}+\dot{q}_{i})=0\\
                &M(q_i)(\dot{q}_{i+1}-\dot{q}_i)+F(q_i,\dot{q_i+1})dt-\tau_i dt-J^(q_i)F_idt=0\\
            \end{aligned}
         \right.} &\color{Crimson}{Dynamics}\\
        &\color{DodgerBlue}{\left\{
            \begin{aligned}
                &q_0=q_{init}\\
                &\underline{q}\le q \le \bar{q}\\
                &\underline{\dot{q}} \le \dot{q} \le \bar{\dot{q}}\\
                &\underline{\tau}(\dot{q})\le \tau \le \bar{\tau}(\dot{q})\\
                &\underline{\gamma}\le \gamma \le \bar{\gamma}\\
            \end{aligned}
        \right.} &\color{DodgerBlue}{Boundary} \\
    \end{aligned}
    \end{aligned}
    $$
    ```python
    ## 2023.02.28/shenzhan_gam3.24-3.42
    # 几何参数
    l1 = 0.4
    l2 = 0.4
    m1 = 2.0
    m2 = 2.0
    
    # 电机参数
    U0 = 24.0
    R = 0.127
    Kv = 0.6
    Kt = 0.075
    Im = 5e-4
    
    # 特征时间和约束条件
    ts = 0.2
    self.q_LB = [-np.pi/2, 0] 
    self.q_UB = [2*np.pi/3, 2*np.pi/3] 
    init(walker.gam[0], 5.0)
    init(walker.gam[1], 2.6)
    init(walker.q[i][0], np.pi/6) # 初始值
    ceq.extend([x_end**2/0.48+y_end**2/0.27 - 1==0]) # 椭圆轨迹限制

    ## 结果
    Lambda = 12.2
    gamma = [3.24, 3.42]
    ```

    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/2023-02-28-21-02-18traj_ani-2023-02-28-21-07-31.gif .gif" alt="2023-02-28-21-02-18traj_ani-2023-02-28-21-07-31.gif " > </div>
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Lambda_e-2023-02-28-21-13-56.jpg .jpg" alt="Lambda_e-2023-02-28-21-13-56.jpg " > </div>
    
    |参数|轨迹优化|冲量模型|
    | ---- | -------- | ---------------- |
    |关节1减速比$\gamma_1$| 3.2 | 3-6 |
    |关节2减速比$\gamma_2$| 3.4 | 2-4 |
    - 对于收缩轨迹的结果验证可以发现，轨迹优化得到的参数基本落在了冲量模型的最有范围内，可以验证给定构型下基于冲量模型优化参数的合理性与可行性

##### 伸展轨迹验证
- 冲量模型的动力学方程可表示为
    $$
    M(q)\ddot q+C(q,\dot q) = 
    -\frac{k_tU_0}{R}
    \begin{bmatrix}
    \gamma_{1}\\
    \gamma_{2}\\
    \end{bmatrix} -
    \frac{k_tk_v}{R}
    \begin{bmatrix}
    \gamma_{1}^2\\
    \gamma_{2}^2\\
    \end{bmatrix}\dot q
    $$
    $$
    \Lambda = M_c\Delta{\dot q}=(JM^{-1}J^T)^{-1}\Delta{\dot q}
    $$
    取特征时间t=0.2s，可以得到不同参数下冲量的分布图
    ```python
    # 2023.02.26
    # 几何参数
    l1 = 0.4
    l2 = 0.4
    m1 = 2.0
    m2 = 2.0

    # 电机参数
    U0 = 24.0
    R = 0.127
    Kv = 0.6
    Kt = 0.075
    Im = 5e-4

    # 特征时间和减速比参数
    ts = 0.2
    Nsample = 200
    t = np.linspace(0, ts, Nsample)
    gamma = np.linspace(1,20,20)
    gamma2 = np.linspace(1,20,20)

    ## 优化结果
    # 通过设定关节2最大角度不超过2*np.pi/3来找出可行域
    gam1 = 3-8
    gam2 = 4-5
    ```
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/t_0.2-pm_3-3_0.67-2023-02-28-21-28-52.gif .gif" alt="t_0.2-pm_3-3_0.67-2023-02-28-21-28-52.gif " > </div>
    q2角度分布变化（小于0度均为不可解）
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/q2m_0.67q2-2023-02-28-21-29-18.png .png" alt="q2m_0.67q2-2023-02-28-21-29-18.png " > </div>
    冲量Lamda分布
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Lam_0.67q2-2023-02-28-21-29-18.png .png" alt="Lam_0.67q2-2023-02-28-21-29-18.png " > </div>
- 轨迹优化方法和结果
  - 轨迹求解的优化方程和约束
    $$
    \begin{aligned}
    &\min_{q_i,\dot{q}_i,\tau_i,F_i}{\sum^n_{i=0}(\tau_{1i} \dot q_{1i}+\tau_{2i} \dot q_{2i})^2}\\
    &\quad\quad s.t.\quad
    \begin{aligned}
        &\color{Crimson}{\left\{
            \begin{aligned}
                &q_{i+1}-q_i-\frac{dt}{2}(\dot{q}_{i+1}+\dot{q}_{i})=0\\
                &M(q_i)(\dot{q}_{i+1}-\dot{q}_i)+F(q_i,\dot{q_i+1})dt-\tau_i dt-J^(q_i)F_idt=0\\
            \end{aligned}
         \right.} &\color{Crimson}{Dynamics}\\
        &\color{DodgerBlue}{\left\{
            \begin{aligned}
                &q_0=q_{init}\\
                &\underline{q}\le q \le \bar{q}\\
                &\underline{\dot{q}} \le \dot{q} \le \bar{\dot{q}}\\
                &\underline{\tau}(\dot{q})\le \tau \le \bar{\tau}(\dot{q})\\
                &\underline{\gamma}\le \gamma \le \bar{\gamma}\\
            \end{aligned}
        \right.} &\color{DodgerBlue}{Boundary} \\
    \end{aligned}
    \end{aligned}
    $$
    ```python
    ## 2023.02.28/GAM5.13-3.47
    # 几何参数
    l1 = 0.4
    l2 = 0.4
    m1 = 2.0
    m2 = 2.0
    
    # 电机参数
    U0 = 24.0
    R = 0.127
    Kv = 0.6
    Kt = 0.075
    Im = 5e-4
    
    # 特征时间和约束条件
    ts = 0.2
    self.q_UB = [2*np.pi/3, 2*np.pi/3] 
    init(walker.gam[0], 5.0)
    init(walker.gam[1], 4.3)    # 5.13-3.47
    init(walker.q[i][0], np.pi*0.4) # 初始值
    x_eff = 0.64
    y_eff = 0.78
    ceq.extend([x_end**2/(x_eff**2)+y_end**2/(y_eff**2) - 1==0]) # 椭圆轨迹限制

    ## 结果
    Lambda = 16
    gamma = [5.13, 3.47]
    ```

    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/2023-02-28-20-58-46traj_ani-2023-02-28-21-16-47.gif .gif" alt="2023-02-28-20-58-46traj_ani-2023-02-28-21-16-47.gif " > </div>
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Lambda_e-2023-02-28-21-17-30.jpg .jpg" alt="Lambda_e-2023-02-28-21-17-30.jpg " > </div>
    
    |参数|轨迹优化|冲量模型|
    | ---- | -------- | ---------------- |
    |关节1减速比$\gamma_1$| 5.13 | 3-8 |
    |关节2减速比$\gamma_2$| 3.47 | 4-5 |
    - 对于伸展轨迹的结果验证也可以发现，轨迹优化得到的参数基本落在了冲量模型的最有范围内，可以验证给定构型下基于冲量模型优化参数的合理性与可行性

#### 基于冲量模型的多参数协同优化
  <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/impact_twolink-2023-03-08-14-10-54.png .png" alt="impact_twolink-2023-03-08-14-10-54.png " > </div>

- 为了减少优化的参数，使得结果可视化效果更好，因此在优化质量和减速比的时候，选择优化其比例系数，这样将优化参数从四个减少到两个。

- 优化参数设置,对于此工况取gamma2 = 4附近， 当gam更大时，相同工况冲量减少，gam更小，运动会超过角度限制。​取M=4附近，该质量主要参考人体手臂的质量(Paolo de Leva (1996))，M越小时，冲量越小。
  $$
    \left\{
        \begin{aligned}
            &m_1+m_2=M\\
            &m1 = Km_2\\
            &\gamma_1 = N\gamma_2\\
            &取M=4.0kg, \quad \gamma_2=4.0\\
        \end{aligned}
    \right.
  $$
- 因此其动力方程变为以下形式，同时优化参数为K, N
  $$
  M(q)\ddot q+C(q,\dot q) = 
    \frac{k_tU_0}{R}
    \begin{bmatrix}
    N\gamma_{2}\\
    \gamma_{2}\\
    \end{bmatrix} -
    \frac{k_tk_v}{R}
    \begin{bmatrix}
    N^2\gamma_{2}^2\\
    \gamma_{2}^2\\
    \end{bmatrix}\dot q
  $$
- 通过以下参数设置可以得到优化结果
  ```python
    # 2023.03.07/lam-M_4-G_4.png、q2-M_4-G_4.png、t_0.2-pm_3-4_0.67.gif
    # 几何参数
    l1 = 0.4
    l2 = 0.4
    m1 = 2.0
    m2 = 2.0

    # 电机参数
    U0 = 24.0
    R = 0.127
    Kv = 0.6
    Kt = 0.075
    Im = 5e-4

    # 特征时间和减速比参数
    ts = 0.2
    Nsample = 200
    t = np.linspace(0, ts, Nsample)
    M = 4.0
    gam2 = 4.0
    N = np.linspace(0.5,6,20)
    K = np.linspace(0.8,6,20)
    q_init = (-np.pi/6,0.001, np.pi/8, 0.001)

    # 优化结果
    K=0.8
    N=0.8
  ```
- 优化结果
  |参数|数值|
  | ---- | -------- |
  |关节1减速比$\gamma_1$| 3.2 |
  |关节2减速比$\gamma_2$| 4.0 |
  |上臂质量$m_1$(kg)| 1.78 |
  |前臂质量$m_2$(kg)| 2.2 |
  <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/q2-M4-G_4-2023-03-08-14-28-44.png .png" alt="q2-M4-G_4-2023-03-08-14-28-44.png " > </div>
  <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/lam-M_4-G_4-2023-03-08-14-28-44.png .png" alt="lam-M_4-G_4-2023-03-08-14-28-44.png " > </div>
  <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/t_0.2-pm_3-4_0.67-2023-03-08-14-28-44.gif .gif" alt="t_0.2-pm_3-4_0.67-2023-03-08-14-28-44.gif " > </div>
- 结果分析
  - 从结果可以看到，整体上左下角是冲量极大值区域，而同时由q2最大角度分布图可以看到，左下角区域在角度限制范围内，因此该区域的极大值组合是合理的,可以通过选取最大的冲量确定对应的减速比和质量组合。
  - 从变化规律上看，冲量分布相对于质量系数是单调的，相对于减速比系数在0.8-0.9范围内取极大值，因此可以详细分析一下其解析公式，是否可以从理论上分析其变化内在原理。

#### 基于轨迹优化和全身动力学在稳定恢复工况下多参数协同优化
- 为了验证基于冲量模型得到结果是否与全身动力学轨迹优化得到的参数在数值和影响结果上具有一定的一致性，因此我们也基于轨迹优化和全身动力学针对稳定恢复工况下对机械臂进行多参数协同优化。
  <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/bal-opt-2023-03-08-14-40-51.png .png" alt="bal-opt-2023-03-08-14-40-51.png " > </div>

- 基于轨迹优化的动力学方程及其约束条件如下，优化参数为机械臂各部分质量、后三个关节减速比等
  $$
  \begin{aligned}
    &\min_{m,\gamma,q_i,\dot{q}_i,\tau_i,F_i}{\sum^n_{i=0}{(\frac{q_i-q_{tar}}{q_m})^2+(\frac{\dot q_i-\dot q_{tar}}{\dot q_m})^2+(\frac{\tau_i}{\tau_m})^2}}\\
    &\quad\quad s.t.\quad
    \begin{aligned}
        &\color{Crimson}{\left\{
            \begin{aligned}
                &q_{i+1}-q_i-\frac{dt}{2}(\dot{q}_{i+1}+\dot{q}_{i})=0\\
                &M(q_i)(\dot{q}_{i+1}-\dot{q}_i)+F(q_i,\dot{q_i+1})dt-\tau_i dt-J^(q_i)F_idt=0\\
            \end{aligned}
         \right.} &\color{Crimson}{Dynamics}\\
        &\color{DodgerBlue}{\left\{
            \begin{aligned}
                &q_0=q_{init}\\
                &\underline{q}\le q \le \bar{q}\\
                &\underline{\dot{q}} \le \dot{q} \le \bar{\dot{q}}\\
                &\underline{\tau}(\dot{q})\le \tau \le \bar{\tau}(\dot{q})\\
                &\underline{\gamma}\le \gamma \le \bar{\gamma}\\
                &\underline{m}\le m \le \bar{m}\\
            \end{aligned}
        \right.} &\color{DodgerBlue}{Boundary} \\
    \end{aligned}
    \end{aligned}
  $$
- 通过数值优化可以得到参数优化结果
  ```python
    # 2023.03.07/traj_test
    # 几何参数
    l1 = 0.4
    l2 = 0.4

    # 电机参数
    U0 = 24.0
    R = 0.127
    Kv = 0.6
    Kt = 0.075
    Im = 5e-4

    ## 惯性参数设置
    t = 2s
    N = 500
    self.mm1 = [10, 15]
    self.mm2 = self.opti.variable(2)
    self.gam = self.opti.variable(3)

    tor_k = 12
    self.qmax = [0.5*np.pi, 0.9*np.pi, 1.2*np.pi, 0.9*np.pi]
    self.dqmax = [36, 54/self.gam[0], 54/self.gam[1], 54/self.gam[2]]
    self.umax = [tor_k, 36*self.gam[0], 36*self.gam[1], 36*self.gam[2]]

    self.u_LB = [-tor_k] + [-self.motor_mt]*3
    self.u_UB = [tor_k] + [self.motor_mt]*3

    # shank, thigh, body, arm, forearm
    self.q_LB = [-np.pi/10, -np.pi/30, 0, -np.pi*0.9] 
    self.q_UB = [np.pi/2, np.pi*0.9, 1.2*np.pi, 0]

    ## 初始参数设置
    init(walker.gam[0], 1.6)
    init(walker.gam[1], 4.0)
    init(walker.gam[2], 4.0)
    init(walker.mm2[0], 5.0)
    init(walker.mm2[1], 4.0)

    # 目标函数权重系数
    Pf = [0.3]*4, Vf = [0.6]*4, Ff = [0.1]*4

    ## 约束条件
    ceq.extend([walker.mm2[0]-0.8*walker.mm2[1] >= 0])
    ceq.extend([walker.opti.bounded(1.0,
                    walker.gam[0], 2.0)])
    ceq.extend([walker.opti.bounded(1.0,
                    walker.gam[1], 10.0)])
    ceq.extend([walker.opti.bounded(1.0,
                    walker.gam[2], 10.0)])
    ceq.extend([walker.opti.bounded(3.0,
                    walker.mm2[0], 10.0)])
    ceq.extend([walker.opti.bounded(1.0,
                    walker.mm2[1], 10.0)])
    
    ## 初始位置
    theta = np.pi/30
    ceq.extend([walker.q[0][0]==theta])
    ceq.extend([walker.q[0][1]==theta*0.2])
  ```
  - 优化结果
    |参数|轨迹优化|
    | ---- | -------- |
    |腰关节减速比$\gamma_0$| 2.0 |
    |肩关节减速比$\gamma_1$| 2.9 |
    |肘关节减速比$\gamma_2$| 4.2 |
    |上臂质量$m_1$(kg)| 3.0（双） |
    |前臂质量$m_2$(kg)| 3.75（双） |
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/Pos-Vel-uF-2023-03-08-14-58-40.jpg .jpg" alt="Pos-Vel-uF-2023-03-08-14-58-40.jpg " > </div>
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/2023-03-07-11-21-25traj_ani-2023-03-08-14-54-52.gif .gif" alt="2023-03-07-11-21-25traj_ani-2023-03-08-14-54-52.gif " > </div>

  - 结果分析
    - 从优化结果可以看到，参数优化在数值上与基于冲量模型的结果相差不是很大，在可接受范围内
    - 关节减速比在瞬间达到了电压限制的力矩曲线峰值，超过了热效应的力矩峰值，但瞬间的作用可以消除，因此该结果可以接受


#### 不同工况下结果对比
- 冲量模型和轨迹优化的结果对比
    |参数|轨迹优化|冲量模型|
    | ---- | -------- | -------- |
    |腰关节减速比$\gamma_0$| 2.0 | \ |
    |肩关节减速比$\gamma_1$| 2.9 | 3.2 |
    |肘关节减速比$\gamma_2$| 4.2 | 4.0 |
    |上臂质量$m_1$(kg)| 3.0（双） | 1.78 |
    |前臂质量$m_2$(kg)| 3.75（双） | 2.2 |

- 两组参数和无臂摆动下的结果对比
  ```python
    # 2023.03.07/traj_test、model_test、noarm
    # 几何参数,其他参数保持一致
    self.mm1 = [10, 15]
    ## model test
    self.mm2 = [3.5, 4.4]
    self.gam = [2.0, 3.2, 4.0]
    ## traj-opt test
    self.mm2 = [3.0, 3.75]
    self.gam = [2.0, 2.9, 4.2]
    ## noarm test
    self.mm2 = [3.0, 3.75]
    self.gam = [2.0, 3.0, 4.0]

  ```
  - 质心变化结果：
    |COM_Y 恢复时间|时间|
    | ---- | -------- |
    |冲击模型| 0.87s |
    |轨迹优化| 0.92s |
    |无臂摆动| 1.62s |
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/xcom-2023-03-08-15-09-36.png .png" alt="xcom-2023-03-08-15-09-36.png " > </div>
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/xcom-2023-03-08-15-09-49.png .png" alt="xcom-2023-03-08-15-09-49.png " > </div>

  - 功率和做功结果对比和平均力
    |参数|冲量模型|轨迹优化|无臂摆动|
    | ---- | -------- | -------- | -------- |
    |总功| 206.97J | 206.09J | 251.1J |
    |净功| 34.49J | 34.44J | -3.82J |

    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/ws-2023-03-08-15-17-37.png .png" alt="ws-2023-03-08-15-17-37.png " > </div>
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/p_w-2023-03-08-15-16-23.png .png" alt="p_w-2023-03-08-15-16-23.png " > </div>
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/p_k-2023-03-08-15-16-23.png .png" alt="p_k-2023-03-08-15-16-23.png " > </div>
    <div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/Stylite-Y/MyTypora@master/img/md/forcemean-2023-03-08-15-19-00.png .png" alt="forcemean-2023-03-08-15-19-00.png " > </div>

- 结果分析
  - 基于冲量模型和轨迹优化得到的优化结果基本一致
  - 上述结果间接表明冲量最大化是在身体稳定恢复过程中手臂作用的原理之一
  - 验证了通过冲量模型优化复杂动态工况下机械臂参数的可行性​
  - 手臂摆动先比于手臂束缚可以减少稳定恢复时间，减低力矩和做功需求。

#### 基于强化学习的双足奔跑工况中双臂的稳定性研究